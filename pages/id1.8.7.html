<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title id="pageTitle">Convoyrama | Generador de Licencia</title>
  <meta name="description" content="Convoyrama">
  <link rel="stylesheet" href="../assets/style.css">
  <link rel="icon" href="../assets/images/favicon.png">
  <link rel="apple-touch-icon" href="../assets/images/favicon.png">
  <script src="https://cdn.jsdelivr.net/npm/qrious@4.0.2/dist/qrious.min.js"></script>
  <script src="https://twemoji.maxcdn.com/v/latest/twemoji.min.js" crossorigin="anonymous"></script>
  <style>
    @font-face {
      font-family: 'Open Sans';
      src: url('./open-sans/OpenSans-Bold.ttf') format('truetype');
      font-weight: 700;
      font-style: normal;
    }
    header {
      padding: 15px;
      text-align: center;
      position: relative;
      z-index: 10;
      background: var(--accent-bg);
      border-bottom: 1px solid var(--border);
    }
    header p {
      font-size: 1.2em;
      text-shadow: none;
      font-family: Arial, sans-serif;
      font-weight: normal;
      margin: 10px 0;
      color: #fff;
    }
    nav {
      padding: 10px;
      text-align: center;
    }
    nav a,
    nav a:visited {
      text-decoration: none;
      margin: 0 15px;
      font-size: 1em;
      text-shadow: none;
      color: #fff;
    }
    nav a:hover {
      text-decoration: underline;
    }
    .contenedor {
      display: flex;
      gap: 20px;
      padding: 20px;
      align-items: flex-start;
      font-family: Arial, sans-serif;
    }
    .panel {
      flex: 1;
      max-width: 300px;
      font-size: 14px;
    }
    .panel h3 {
      margin: 10px 0 5px;
      font-size: 14px;
    }
    .input-group {
      margin: 6px 0;
    }
    .toggle-group {
      display: flex;
      gap: 10px;
      justify-content: space-between;
    }
    .toggle-group .toggle-item {
      flex: 1;
    }
    canvas {
      border: 1px solid #000;
      display: block;
      max-width: 100%;
      height: auto;
    }
    #preview {
      flex: 1;
      text-align: center;
    }
    button {
      padding: 6px 12px;
      font-size: 14px;
      margin-top: 10px;
      background: rgb(90,165,25);
      color: #fff;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }
    button:hover {
      opacity: 0.8;
    }
    .hidden {
      display: none;
    }
    #truckersmpStatus {
      font-size: 12px;
      color: #555;
      margin-top: 5px;
    }
    .valid {
      color: green;
    }
    .invalid {
      color: red;
    }
    #colorSlider {
      width: 80%;
      margin-top: 5px;
      vertical-align: middle;
    }
    #colorValue {
      display: inline-block;
      width: 15%;
      text-align: right;
      font-size: 14px;
      color: #555;
    }
    .info-tooltip {
      display: inline-block;
      font-size: 16px;
      font-weight: bold;
      color: rgb(90,165,25);
      cursor: help;
      margin-left: 10px;
      position: relative;
    }
    .info-tooltip:hover::after {
      content: attr(data-tooltip);
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      background: #333;
      color: #fff;
      padding: 5px 10px;
      border-radius: 4px;
      font-size: 12px;
      white-space: nowrap;
      z-index: 10;
    }
  </style>
</head>

<body>
  <header>
    <nav>
      <a href="../index.html">Home</a>
      <a href="pc.html">Creador de Perfil</a>
      <a href="id.html" id="navLicense">Licencia</a>
    </nav>
    <p id="headerTitle">Generador de Licencia de Conductor</p>
  </header>

  <div class="contenedor">
    <div class="panel">
      <div class="input-group">
        <label for="languageToggle">Idioma / Language / Língua:</label><br>
        <select id="languageToggle" style="width:100%">
          <option value="es">Español</option>
          <option value="en">English</option>
          <option value="pt">Português</option>
        </select>
      </div>
      <div class="input-group">
        <label id="fontLabel">Fuente: <span id="fontName">Open Sans</span></label>
      </div>
      <div class="input-group">
        <label for="colorSlider" id="colorLabel">Tono del fondo:</label><br>
        <input type="range" id="colorSlider" min="0" max="360" value="0" style="width:80%">
        <span id="colorValue">0°</span>
      </div>
      <div class="input-group">
        <label for="nombre" id="nameLabel">Nombre:</label><br>
        <input type="text" id="nombre" placeholder="Nombre / Name / Nome" required>
      </div>
      <div class="input-group hidden" id="nicknameGroup">
        <label for="nickname" id="nicknameLabel">TAG Épico:</label><br>
        <select id="nickname" style="width:100%">
          <option value="">Seleccione un TAG</option>
          <option value="ReyDelLag">ReyDelLag</option>
          <option value="FrenadorEnCurva">FrenadorEnCurva</option>
          <option value="SeñorDelLagazo">SeñorDelLagazo</option>
          <option value="BocinaLoca">BocinaLoca</option>
          <option value="CargadorDeDeudas">CargadorDeDeudas</option>
          <option value="CamioneroDelApagón">CamioneroDelApagón</option>
          <option value="FugitivoDeLaRuta">FugitivoDeLaRuta</option>
          <option value="MaestroDelPing">MaestroDelPing</option>
          <option value="ReyDeLaCarretera">ReyDeLaCarretera</option>
          <option value="LocoDelVolante">LocoDelVolante</option>
          <option value="SobrevivienteDelBan">SobrevivienteDelBan</option>
          <option value="BanEvasor">BanEvasor</option>
          <option value="FrenazoEstelar">FrenazoEstelar</option>
          <option value="TerrorDeCalais">TerrorDeCalais</option>
          <option value="LagLegendario">LagLegendario</option>
          <option value="SobrevivienteDeKirkenes">SobrevivienteDeKirkenes</option>
          <option value="MaestroDelReckless">MaestroDelReckless</option>
          <option value="PingParalizante">PingParalizante</option>
          <option value="RutaSinRetorno">RutaSinRetorno</option>
          <option value="VolanteEndemoniado">VolanteEndemoniado</option>
          <option value="AsDelReporte">AsDelReporte</option>
          <option value="ReyDeDuisburg">ReyDeDuisburg</option>
          <option value="ReyDeCalais">ReyDeCalais</option>
          <option value="KaosEnLaRuta">KaosEnLaRuta</option>
          <option value="CarreteraPerdida">CarreteraPerdida</option>
          <option value="FrenadorDePánico">FrenadorDePánico</option>
          <option value="CargaConDrama">CargaConDrama</option>
        </select>
      </div>
      <div class="input-group hidden" id="titleToggleGroup">
        <label for="titleToggle" id="titleToggleLabel">Usar título cómico:</label><br>
        <input type="checkbox" id="titleToggle">
      </div>
      <div class="input-group">
        <label for="foto" id="photoLabel">Foto (Opcional):</label><br>
        <input type="file" id="foto" accept="image/*">
      </div>
      <div class="input-group">
        <label for="pais" id="countryLabel">País:</label><br>
        <select id="pais" style="width:100%" required>
          <option value="">Seleccione un país / Select a country / Selecione um país</option>
          <option value="AO|🇦🇴|Angola|Angola|Angola">🇦🇴 Angola</option>
          <option value="AR|🇦🇷|Argentina|Argentina|Argentina">🇦🇷 Argentina</option>
          <option value="BO|🇧🇴|Bolivia|Bolivia|Bolívia">🇧🇴 Bolivia</option>
          <option value="BR|🇧🇷|Brasil|Brazil|Brasil">🇧🇷 Brasil</option>
          <option value="BZ|🇧🇿|Belice|Belize|Belize">🇧🇿 Belice</option>
          <option value="CA|🇨🇦|Canadá|Canada|Canadá">🇨🇦 Canadá</option>
          <option value="CL|🇨🇱|Chile|Chile|Chile">🇨🇱 Chile</option>
          <option value="CN|🇨🇳|China|China|China">🇨🇳 China</option>
          <option value="CO|🇨🇴|Colombia|Colombia|Colômbia">🇨🇴 Colombia</option>
          <option value="CR|🇨🇷|Costa Rica|Costa Rica|Costa Rica">🇨🇷 Costa Rica</option>
          <option value="CU|🇨🇺|Cuba|Cuba|Cuba">🇨🇺 Cuba</option>
          <option value="DE|🇩🇪|Alemania|Germany|Alemanha">🇩🇪 Alemania</option>
          <option value="DO|🇩🇴|República Dominicana|Dominican Republic|República Dominicana">🇩🇴 República Dominicana</option>
          <option value="EC|🇪🇨|Ecuador|Ecuador|Equador">🇪🇨 Ecuador</option>
          <option value="ES|🇪🇸|España|Spain|Espanha">🇪🇸 España</option>
          <option value="FR|🇫🇷|Francia|France|França">🇫🇷 Francia</option>
          <option value="GB|🇬🇧|Reino Unido|United Kingdom (England/Scotland)|Reino Unido">🇬🇧 Reino Unido</option>
          <option value="GT|🇬🇹|Guatemala|Guatemala|Guatemala">🇬🇹 Guatemala</option>
          <option value="GY|🇬🇾|Guyana|Guyana|Guiana">🇬🇾 Guyana</option>
          <option value="HN|🇭🇳|Honduras|Honduras|Honduras">🇭🇳 Honduras</option>
          <option value="IE|🇮🇪|Irlanda|Ireland|Irlanda">🇮🇪 Irlanda</option>
          <option value="IT|🇮🇹|Italia|Italy|Itália">🇮🇹 Italia</option>
          <option value="JM|🇯🇲|Jamaica|Jamaica|Jamaica">🇯🇲 Jamaica</option>
          <option value="JP|🇯🇵|Japón|Japan|Japão">🇯🇵 Japón</option>
          <option value="MX|🇲🇽|México|Mexico|México">🇲🇽 México</option>
          <option value="MZ|🇲🇿|Mozambique|Mozambique|Moçambique">🇲🇿 Mozambique</option>
          <option value="NI|🇳🇮|Nicaragua|Nicaragua|Nicarágua">🇳🇮 Nicaragua</option>
          <option value="PA|🇵🇦|Panamá|Panama|Panamá">🇵🇦 Panamá</option>
          <option value="PE|🇵🇪|Perú|Peru|Peru">🇵🇪 Perú</option>
          <option value="PI|🏴‍☠️|Pirata|Pirate|Pirata">🏴‍☠️ Pirata</option>
          <option value="PL|🇵🇱|Polonia|Poland|Polônia">🇵🇱 Polonia</option>
          <option value="PT|🇵🇹|Portugal|Portugal|Portugal">🇵🇹 Portugal</option>
          <option value="PY|🇵🇾|Paraguay|Paraguay|Paraguai">🇵🇾 Paraguay</option>
          <option value="RO|🇷🇴|Rumania|Romania|Romênia">🇷🇴 Rumania</option>
          <option value="RU|🇷🇺|Rusia|Russia|Rússia">🇷🇺 Rusia</option>
          <option value="SR|🇸🇷|Surinam|Suriname|Suriname">🇸🇷 Surinam</option>
          <option value="SV|🇸🇻|El Salvador|El Salvador|El Salvador">🇸🇻 El Salvador</option>
          <option value="TR|🇹🇷|Turquía|Turkey|Turquia">🇹🇷 Turquía</option>
          <option value="UA|🇺🇦|Ucrania|Ukraine|Ucrânia">🇺🇦 Ucrania</option>
          <option value="US|🇺🇸|Estados Unidos|United States|Estados Unidos">🇺🇸 Estados Unidos</option>
          <option value="UY|🇺🇾|Uruguay|Uruguay|Uruguai" selected>🇺🇾 Uruguay</option>
          <option value="VE|🇻🇪|Venezuela|Venezuela|Venezuela">🇻🇪 Venezuela</option>
        </select>
      </div>
      <div class="input-group" id="empresaGroup">
        <label for="empresa" id="companyLabel">Empresa:</label><br>
        <select id="empresa" style="width:100%" onchange="updateForm()">
          <option value="LS" selected>LS</option>
          <option value="CN">CN</option>
          <option value="TCS">TCS</option>
          <option value="Otro">Otra</option>
        </select>
      </div>
      <div class="input-group hidden" id="empresaLinkGroup">
        <label for="empresaLink" id="companyLinkLabel">Enlace Perfil Empresa en TMP:</label><br>
        <input type="text" id="empresaLink" placeholder="TruckersMP Company Profile Link" required>
      </div>
      <div class="input-group">
        <label for="truckersmpLink" id="truckersmpLinkLabel">Enlace Perfil en TMP:</label><br>
        <input type="text" id="truckersmpLink" placeholder="TruckersMP Profile Link" required>
        <div id="truckersmpStatus"></div>
      </div>
      <div class="input-group toggle-group">
        <div class="toggle-item">
          <label for="promodsToggle">ProMods:</label><br>
          <input type="checkbox" id="promodsToggle">
        </div>
        <div class="toggle-item">
          <label for="dbusworldToggle">DBUS:</label><br>
          <input type="checkbox" id="dbusworldToggle">
        </div>
      </div>
    </div>
    <div id="preview">
      <canvas id="canvas" width="800" height="500"></canvas>
      <br>
      <a id="descargar" download="driver_license.png">
        <button id="botonDescargar">Descargar Licencia</button>
      </a>
      <span class="info-tooltip" id="infoTooltip">?</span>
    </div>
  </div>

  <footer>
    <small>© LAG'S SPEED - CONVOYRAMA 2025 - versión 1.8.7</small>
  </footer>

  <script>
    function rasterizeTwemoji(emoji, size) {
      return new Promise((resolve) => {
        const img = new Image();
        img.onload = () => {
          console.log(`Loaded twemoji: ${emoji}`);
          resolve(img);
        };
        img.onerror = () => {
          console.error(`Failed to load twemoji: ${emoji}`);
          resolve(null);
        };
        img.src = twemoji.parse(emoji, { folder: 'svg', ext: '.svg' }).match(/src="([^"]+)"/)[1];
        img.crossOrigin = "anonymous";
      });
    }

    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d");

    const config = {
      color: "white",
      flagSize: 80,
      photoX: 45,
      photoY: 80,
      labelX: 100,
      colonX: 130,
      textX: 295,
      textY: 334,
      qrX: 573,
      qrY: 101,
      flagX: 625,
      flagY: 206,
      font: "'Open Sans', Arial, sans-serif",
      defaultPhotoSize: 192,
      qrSize: 100,
      qrSpacing: 10,
      promodsX: 20,
      promodsY: 334,
      dbusworldX: 20,
      dbusworldY: 394,
      logoWidth: 67,
      logoHeight: 50,
      vtcLogoHeight: 80
    };

    const vtcMap = {
      "https://truckersmp.com/vtc/55250-andesvtc": "andes.png",
      "https://truckersmp.com/vtc/55250": "andes.png",
      "https://truckersmp.com/vtc/29591": "castores.jpg",
      "https://truckersmp.com/vtc/81636": "chapu.jpeg",
      "https://truckersmp.com/vtc/55439-destiny": "destiny.png",
      "https://truckersmp.com/vtc/55439": "destiny.png",
      "https://truckersmp.com/vtc/56572-lsavtc": "lsa.png",
      "https://truckersmp.com/vtc/56572": "lsa.png",
      "https://truckersmp.com/vtc/79357": "norte.png",
      "https://truckersmp.com/vtc/34966-nova-era": "nova.png",
      "https://truckersmp.com/vtc/34966": "nova.png",
      "https://truckersmp.com/vtc/64312": "shipeados.png",
      "https://truckersmp.com/vtc/65011": "tl.png",
      "https://truckersmp.com/vtc/17910-transportesatr": "atr.png",
      "https://truckersmp.com/vtc/17910": "atr.png",
      "https://truckersmp.com/vtc/63758": "cord.jpg",
      "https://truckersmp.com/vtc/48970": "sin.jpg",
      "https://truckersmp.com/vtc/70703": "as.png",
      "https://truckersmp.com/vtc/77802": "ex.png",
      "https://truckersmp.com/vtc/62448": "rut.jpg",
      "https://truckersmp.com/vtc/11715": "avant.png",
      "https://truckersmp.com/vtc/76975": "titan.png",
      "https://truckersmp.com/vtc/3414": "baltico.png",
      "https://truckersmp.com/vtc/79130": "corr.png",
      "https://truckersmp.com/vtc/74222": "esp.jpg",
      "https://truckersmp.com/vtc/63303": "coo.png"
    };

    const translations = {
      es: {
        pageTitle: "Convoyrama | Generador de Licencia",
        headerTitle: "Generador de Licencia de Conductor",
        navLicense: "Licencia",
        fontLabel: "Fuente: ",
        nameLabel: "Nombre:",
        nicknameLabel: "TAG Épico:",
        titleToggleLabel: "Usar título cómico:",
        photoLabel: "Foto (Opcional):",
        countryLabel: "País:",
        companyLabel: "Empresa:",
        companyOther: "Otra",
        companyLinkLabel: "Enlace Perfil Empresa en TMP:",
        truckersmpLinkLabel: "Enlace Perfil en TMP:",
        validLink: "Enlace válido",
        invalidLink: "Enlace inválido: debe ser https://truckersmp.com/user/[número]",
        downloadButton: "Descargar Licencia",
        canvasName: "Nombre :",
        canvasLicenseNo: "Núm. Licencia :",
        canvasDate: "Fecha :",
        canvasCountry: "País :",
        canvasTag: "TAG :",
        titleNormal: "PERMISO DE CONDUCCIÓN INTERNACIONAL",
        titleComedic: "PERMISO PARA CHOCAR EN CONVOY",
        countryPlaceholder: "Seleccione un país",
        colorLabel: "Tono del fondo:",
        tooltipMessage: "Esta licencia es una broma y un guiño a la comunidad, no pretende ser profesional ni seria."
      },
      en: {
        pageTitle: "Convoyrama | Driver License Generator",
        headerTitle: "Driver License Generator",
        navLicense: "License",
        fontLabel: "Font: ",
        nameLabel: "Name:",
        nicknameLabel: "Epic TAG:",
        titleToggleLabel: "Use comedic title:",
        photoLabel: "Photo (Optional):",
        countryLabel: "Country:",
        companyLabel: "Company:",
        companyOther: "Other",
        companyLinkLabel: "TruckersMP Company Profile Link:",
        truckersmpLinkLabel: "TruckersMP Profile Link:",
        validLink: "Valid link",
        invalidLink: "Invalid link: must be https://truckersmp.com/user/[number]",
        downloadButton: "Download License",
        canvasName: "Name :",
        canvasLicenseNo: "License No. :",
        canvasDate: "Date :",
        canvasCountry: "Country :",
        canvasTag: "TAG :",
        titleNormal: "INTERNATIONAL DRIVING LICENSE",
        titleComedic: "CONVOY CRASHING PERMIT",
        countryPlaceholder: "Select a country",
        colorLabel: "Background hue:",
        tooltipMessage: "This license is a joke and a nod to the community, not intended to be professional or serious."
      },
      pt: {
        pageTitle: "Convoyrama | Gerador de Licença",
        headerTitle: "Gerador de Licença de Motorista",
        navLicense: "Licença",
        fontLabel: "Fonte: ",
        nameLabel: "Nome:",
        nicknameLabel: "TAG Épico:",
        titleToggleLabel: "Usar título cômico:",
        photoLabel: "Foto (Opcional):",
        countryLabel: "País:",
        companyLabel: "Empresa:",
        companyOther: "Outra",
        companyLinkLabel: "Link do Perfil da Empresa no TruckersMP:",
        truckersmpLinkLabel: "Link do Perfil no TruckersMP:",
        validLink: "Link válido",
        invalidLink: "Link inválido: deve ser https://truckersmp.com/user/[número]",
        downloadButton: "Baixar Licença",
        canvasName: "Nome :",
        canvasLicenseNo: "Nº da Licença :",
        canvasDate: "Data :",
        canvasCountry: "País :",
        canvasTag: "TAG :",
        titleNormal: "LICENÇA INTERNACIONAL DE CONDUÇÃO",
        titleComedic: "PERMISSÃO PARA BATER EM CONVOI",
        countryPlaceholder: "Selecione um país",
        colorLabel: "Tom do fundo:",
        tooltipMessage: "Esta licença é uma brincadeira e uma homenagem à comunidade, não pretende ser profissional ou séria."
      }
    };

    const nombreInput = document.getElementById("nombre");
    const fotoInput = document.getElementById("foto");
    const paisInput = document.getElementById("pais");
    const nicknameInput = document.getElementById("nickname");
    const empresaInput = document.getElementById("empresa");
    const empresaLinkInput = document.getElementById("empresaLink");
    const truckersmpLinkInput = document.getElementById("truckersmpLink");
    const truckersmpStatus = document.getElementById("truckersmpStatus");
    const empresaGroup = document.getElementById("empresaGroup");
    const empresaLinkGroup = document.getElementById("empresaLinkGroup");
    const nicknameGroup = document.getElementById("nicknameGroup");
    const titleToggleGroup = document.getElementById("titleToggleGroup");
    const titleToggleInput = document.getElementById("titleToggle");
    const promodsToggleInput = document.getElementById("promodsToggle");
    const dbusworldToggleInput = document.getElementById("dbusworldToggle");
    const languageToggle = document.getElementById("languageToggle");
    const colorSlider = document.getElementById("colorSlider");
    const colorValue = document.getElementById("colorValue");
    const infoTooltip = document.getElementById("infoTooltip");

    let userImage = null;
    let isNicknameUnlocked = localStorage.getItem("nicknameUnlocked") === "true";
    let cachedDate = null;
    let lastDateFetch = 0;
    const DATE_CACHE_DURATION = 60 * 1000;
    let currentLanguage = "es";

    async function getCurrentDate() {
      const now = Date.now();
      if (cachedDate && now - lastDateFetch < DATE_CACHE_DURATION) {
        console.log("Using cached date:", cachedDate);
        return cachedDate;
      }

      const apis = [
        {
          url: 'https://worldtimeapi.org/api/timezone/Etc/UTC',
          parse: (data) => {
            const date = new Date(data.datetime);
            return {
              day: date.getDate().toString().padStart(2, "0"),
              month: (date.getMonth() + 1).toString().padStart(2, "0"),
              year: date.getFullYear()
            };
          }
        },
        {
          url: 'https://timeapi.io/api/Time/current/utc',
          parse: (data) => ({
            day: data.day.toString().padStart(2, "0"),
            month: data.month.toString().padStart(2, "0"),
            year: data.year
          })
        },
        {
          url: 'https://worldclockapi.herokuapp.com/api/json/utc/now',
          parse: (data) => {
            const date = new Date(data.currentDateTime);
            return {
              day: date.getDate().toString().padStart(2, "0"),
              month: (date.getMonth() + 1).toString().padStart(2, "0"),
              year: date.getFullYear()
            };
          }
        }
      ];

      for (const api of apis) {
        try {
          console.log(`Attempting to fetch date from ${api.url}`);
          const response = await fetch(api.url);
          const data = await response.json();
          const { day, month, year } = api.parse(data);
          cachedDate = `${day}/${month}/${year}`;
          lastDateFetch = now;
          console.log(`Successfully fetched date from ${api.url}: ${cachedDate}`);
          return cachedDate;
        } catch (error) {
          console.error(`Failed to fetch date from ${api.url}:`, error);
        }
      }

      console.warn("All API attempts failed, falling back to system date");
      const date = new Date();
      const day = date.getDate().toString().padStart(2, "0");
      const month = (date.getMonth() + 1).toString().padStart(2, "0");
      const year = date.getFullYear();
      cachedDate = `${day}/${month}/${year}`;
      lastDateFetch = now;
      console.log("Using system date:", cachedDate);
      return cachedDate;
    }

    function updateLanguage(lang) {
      currentLanguage = lang;
      const t = translations[lang];

      document.getElementById("pageTitle").textContent = t.pageTitle;
      document.getElementById("headerTitle").textContent = t.headerTitle;
      document.getElementById("navLicense").textContent = t.navLicense;
      document.getElementById("fontLabel").innerHTML = t.fontLabel + '<span id="fontName">Open Sans</span>';
      document.getElementById("nameLabel").textContent = t.nameLabel;
      document.getElementById("nicknameLabel").textContent = t.nicknameLabel;
      document.getElementById("titleToggleLabel").textContent = t.titleToggleLabel;
      document.getElementById("photoLabel").textContent = t.photoLabel;
      document.getElementById("countryLabel").textContent = t.countryLabel;
      document.getElementById("companyLabel").textContent = t.companyLabel;
      document.getElementById("companyLinkLabel").textContent = t.companyLinkLabel;
      document.getElementById("truckersmpLinkLabel").textContent = t.truckersmpLinkLabel;
      document.getElementById("colorLabel").textContent = t.colorLabel;
      document.getElementById("botonDescargar").textContent = t.downloadButton;
      paisInput.options[0].text = t.countryPlaceholder;
      infoTooltip.setAttribute("data-tooltip", t.tooltipMessage);

      const empresaSelect = empresaInput;
      for (let i = 0; i < empresaSelect.options.length; i++) {
        if (empresaSelect.options[i].value === "Otro") {
          empresaSelect.options[i].text = t.companyOther;
        }
      }

      const link = truckersmpLinkInput.value.trim();
      if (link) {
        validateTruckersMPLink(link);
      }

      debouncedGenerarImagen();
    }

    function generarLicenseNumber(nombre, pais, truckersmpLink) {
      const countryCode = pais.split("|")[0].substring(0, 2) || "XX";
      let userId = "";
      if (truckersmpLink) {
        const match = truckersmpLink.match(/truckersmp\.com\/user\/(\d+)/);
        userId = match ? match[1] : "";
      }
      if (userId) {
        return `${countryCode}${userId}`;
      }
      return "";
    }

    function validateTruckersMPLink(link) {
      const regex = /^https:\/\/truckersmp\.com\/user\/\d+$/;
      const t = translations[currentLanguage];
      if (!regex.test(link)) {
        truckersmpStatus.textContent = t.invalidLink;
        truckersmpStatus.className = "invalid";
        return false;
      }
      truckersmpStatus.textContent = t.validLink;
      truckersmpStatus.className = "valid";
      return true;
    }

    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }

    function saveDefaultCountry() {
      localStorage.setItem("defaultCountry", paisInput.value);
    }

    function loadDefaultCountry() {
      const saved = localStorage.getItem("defaultCountry");
      if (saved) paisInput.value = saved;
    }

    function updateForm() {
      console.log("updateForm triggered");
      const empresa = empresaInput.value;
      empresaLinkGroup.classList.toggle("hidden", empresa !== "Otro");

      const colorMap = {
        'LS': 260,
        'CN': 340,
        'TCS': 200,
        'Otro': colorSlider.value
      };
      const newColorValue = colorMap[empresa] || 0;
      colorSlider.value = newColorValue;
      colorValue.textContent = `${newColorValue}°`;
      console.log(`Set color slider to ${newColorValue}° for empresa: ${empresa}`);

      const nombre = nombreInput.value.toLowerCase().trim();
      if (["convoyrama", "nocturnoverso"].includes(nombre)) {
        isNicknameUnlocked = true;
        localStorage.setItem("nicknameUnlocked", "true");
      }
      nicknameGroup.classList.toggle("hidden", !isNicknameUnlocked);
      titleToggleGroup.classList.toggle("hidden", !isNicknameUnlocked);
      debouncedGenerarImagen();
    }

    let lastFormState = {};

    function getFormState() {
      return {
        nombre: nombreInput.value,
        pais: paisInput.value,
        nickname: nicknameInput.value,
        empresa: empresaInput.value,
        truckersmpLink: truckersmpLinkInput.value,
        empresaLink: empresaLinkInput.value,
        titleToggle: titleToggleInput.checked,
        promodsToggle: promodsToggleInput.checked,
        dbusworldToggle: dbusworldToggleInput.checked,
        userImage: userImage ? userImage.src : null,
        language: currentLanguage,
        colorHue: colorSlider.value
      };
    }

    async function generarImagen() {
      console.log("generarImagen triggered at:", new Date().toISOString());
      const formState = getFormState();
      if (JSON.stringify(formState) === JSON.stringify(lastFormState)) {
        console.log("No changes in form state, skipping redraw");
        return;
      }
      lastFormState = formState;

      const t = translations[currentLanguage];
      const nombre = nombreInput.value || (currentLanguage === "es" ? "Sin nombre" : currentLanguage === "en" ? "No name" : "Sem nome");
      const paisData = paisInput.value.split("|");
      const countryCode = paisData[0] || "XX";
      const flag = paisData[1] || "";
      const countryName = paisData[2] || (currentLanguage === "es" ? "Sin país" : currentLanguage === "en" ? "No country" : "Sem país");
      const nickname = nicknameInput.value || "";
      const empresa = empresaInput.value;
      const truckersmpLink = truckersmpLinkInput.value.trim();
      const empresaLink = empresaLinkInput.value.trim();
      const isTruckersMPLinkValid = truckersmpLink ? validateTruckersMPLink(truckersmpLink) : false;
      const hueRotate = parseInt(colorSlider.value);

      if (canvas.width !== 800 || canvas.height !== 500) {
        canvas.width = 800;
        canvas.height = 500;
      }

      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.font = null;
      ctx.fillStyle = null;
      ctx.textAlign = "start";
      ctx.textBaseline = "alphabetic";
      ctx.shadowColor = "transparent";
      ctx.globalCompositeOperation = "source-over";
      ctx.filter = "none";

      const templateImgSrc = {
        'LS': './assets/images/license_template_ls.png',
        'TCS': './assets/images/license_template_tcs.png',
        'CN': './assets/images/license_template_cn.png',
        'Otro': './assets/images/license_template_otro.png'
      }[empresa] || './assets/images/license_template_otro.png';
      console.log("Loading license template:", templateImgSrc);
      const template = new Image();
      template.src = templateImgSrc;

      const empresaImgSrc = {
        'LS': './assets/images/lsb.png',
        'TCS': './assets/images/tcsb.png',
        'CN': './assets/images/cnb.png',
        'Otro': './assets/images/otrosb.png'
      }[empresa] || './assets/images/otrosb.png';
      console.log("Loading empresa layer:", empresaImgSrc);
      const empresaLayer = new Image();
      empresaLayer.src = empresaImgSrc;

      const idiomaImgSrc = {
        'es': './assets/images/es.png',
        'en': './assets/images/en.png',
        'pt': './assets/images/pt.png'
      }[currentLanguage];
      console.log("Loading idioma layer:", idiomaImgSrc);
      const idiomaLayer = new Image();
      idiomaLayer.src = idiomaImgSrc;

      const vtcImgSrc = empresa === "Otro" && empresaLink && vtcMap[empresaLink] ? `./assets/images/vtc/${vtcMap[empresaLink]}` : null;
      const vtcImg = vtcImgSrc ? new Image() : null;
      if (vtcImg) vtcImg.src = vtcImgSrc;

      const [templateImg, empresaLayerImg, idiomaLayerImg, silhouetteImg, flagImg, idImg, leftQrImg, promodsImg, dbusworldImg, vtcLogoImg] = await Promise.all([
        new Promise((resolve) => {
          template.onload = () => {
            console.log(`Loaded license template: ${templateImgSrc}`);
            resolve(template);
          };
          template.onerror = () => {
            console.error(`Failed to load license template: ${templateImgSrc}`);
            resolve(null);
          };
        }),
        new Promise((resolve) => {
          empresaLayer.onload = () => {
            console.log(`Loaded empresa layer: ${empresaImgSrc}`);
            resolve(empresaLayer);
          };
          empresaLayer.onerror = () => {
            console.error(`Failed to load empresa layer: ${empresaImgSrc}`);
            resolve(null);
          };
        }),
        new Promise((resolve) => {
          idiomaLayer.onload = () => {
            console.log(`Loaded idioma layer: ${idiomaImgSrc}`);
            resolve(idiomaLayer);
          };
          idiomaLayer.onerror = () => {
            console.error(`Failed to load idioma layer: ${idiomaImgSrc}`);
            resolve(null);
          };
        }),
        userImage ? Promise.resolve(null) : rasterizeTwemoji("👤", config.defaultPhotoSize),
        flag ? rasterizeTwemoji(flag, config.flagSize) : Promise.resolve(null),
        isTruckersMPLinkValid ? new Promise((resolve) => {
          const img = new Image();
          img.src = "./assets/images/id.svg";
          img.onload = () => {
            console.log("Loaded id.svg");
            resolve(img);
          };
          img.onerror = () => {
            console.error("Failed to load id.svg");
            resolve(null);
          };
        }) : Promise.resolve(null),
        isTruckersMPLinkValid && (empresa === "LS" || empresa === "CN" || empresa === "TCS") ? new Promise((resolve) => {
          const img = new Image();
          img.src = `./assets/images/qr${empresa.toLowerCase()}.svg`;
          img.onload = () => {
            console.log(`Loaded qr${empresa.toLowerCase()}.svg`);
            resolve(img);
          };
          img.onerror = () => {
            console.error(`Failed to load qr${empresa.toLowerCase()}.svg`);
            resolve(null);
          };
        }) : isTruckersMPLinkValid && empresaLink && empresa === "Otro" ? new Promise((resolve) => {
          const qrEmpresa = new QRious({
            value: empresaLink,
            size: config.qrSize,
            level: 'H'
          });
          const qrEmpresaCanvas = document.createElement("canvas");
          qrEmpresaCanvas.width = config.qrSize;
          qrEmpresaCanvas.height = config.qrSize;
          const qrEmpresaCtx = qrEmpresaCanvas.getContext("2d");
          qrEmpresaCtx.drawImage(qrEmpresa.canvas, 0, 0);
          resolve(qrEmpresaCanvas);
        }) : Promise.resolve(null),
        promodsToggleInput.checked ? new Promise((resolve) => {
          const img = new Image();
          img.src = "./assets/images/promods.png";
          img.onload = () => {
            console.log("Loaded promods.png");
            resolve(img);
          };
          img.onerror = () => {
            console.error("Failed to load promods.png");
            resolve(null);
          };
        }) : Promise.resolve(null),
        dbusworldToggleInput.checked ? new Promise((resolve) => {
          const img = new Image();
          img.src = "./assets/images/dbusworld.png";
          img.onload = () => {
            console.log("Loaded dbusworld.png");
            resolve(img);
          };
          img.onerror = () => {
            console.error("Failed to load dbusworld.png");
            resolve(null);
          };
        }) : Promise.resolve(null),
        vtcImg ? new Promise((resolve) => {
          vtcImg.onload = () => {
            console.log(`Loaded VTC logo: ${vtcImgSrc}`);
            resolve(vtcImg);
          };
          vtcImg.onerror = () => {
            console.error(`Failed to load VTC logo: ${vtcImgSrc}`);
            resolve(null);
          };
        }) : Promise.resolve(null)
      ]);

      if (templateImg) {
        ctx.filter = `hue-rotate(${hueRotate}deg)`;
        ctx.drawImage(templateImg, 0, 0, canvas.width, canvas.height);
        ctx.filter = "none";
      } else {
        ctx.fillStyle = "#fff";
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        console.warn("No license template loaded, using white background");
      }

      if (empresaLayerImg) {
        ctx.drawImage(empresaLayerImg, 0, 0, canvas.width, canvas.height);
      }

      if (idiomaLayerImg) {
        ctx.drawImage(idiomaLayerImg, 0, 0, canvas.width, canvas.height);
      }

      if (userImage) {
        const photoSize = config.defaultPhotoSize;
        ctx.drawImage(userImage, config.photoX, config.photoY, photoSize, photoSize);
      } else if (silhouetteImg) {
        ctx.drawImage(silhouetteImg, config.photoX, config.photoY, config.defaultPhotoSize, config.defaultPhotoSize);
      }

      if (flagImg) {
        ctx.drawImage(flagImg, config.flagX - config.flagSize / 2, config.flagY, config.flagSize, config.flagSize);
      }

      if (vtcLogoImg && empresa === "Otro" && isTruckersMPLinkValid) {
        const vtcLogoHeight = config.vtcLogoHeight;
        const vtcLogoWidth = vtcLogoImg ? (vtcLogoImg.width / vtcLogoImg.height) * vtcLogoHeight : vtcLogoHeight;
        const vtcLogoX = config.flagX - config.flagSize / 2 - 70 - vtcLogoWidth / 2;
        const vtcLogoY = config.qrY + config.qrSize + 10;
        ctx.drawImage(vtcLogoImg, vtcLogoX, vtcLogoY, vtcLogoWidth, vtcLogoHeight);
      }

      const currentDate = await getCurrentDate();
      ctx.font = `bold 24px ${config.font}`;
      ctx.fillStyle = config.color;
      ctx.textAlign = "left";

      const lineHeight = 24 * 1.2;
      ctx.fillText(t.canvasName, config.labelX, config.textY);
      ctx.fillText(t.canvasLicenseNo, config.labelX, config.textY + lineHeight);
      ctx.fillText(t.canvasDate, config.labelX, config.textY + lineHeight * 2);
      ctx.fillText(t.canvasCountry, config.labelX, config.textY + lineHeight * 3);
      if (isNicknameUnlocked && nickname) {
        ctx.fillText(t.canvasTag, config.labelX, config.textY + lineHeight * 4);
      }

      ctx.fillText(nombre, config.textX, config.textY);
      if (nombre && nombre.trim() !== "" && paisInput.value && isTruckersMPLinkValid) {
        const licenseNumber = generarLicenseNumber(nombre, paisInput.value, truckersmpLink);
        if (licenseNumber) {
          ctx.fillText(licenseNumber, config.textX, config.textY + lineHeight);
        }
      }
      ctx.fillText(currentDate, config.textX, config.textY + lineHeight * 2);
      ctx.fillText(countryName, config.textX, config.textY + lineHeight * 3);
      if (isNicknameUnlocked && nickname) {
        ctx.fillText(nickname, config.textX, config.textY + lineHeight * 4);
      }

      if (promodsImg && promodsToggleInput.checked) {
        ctx.drawImage(promodsImg, config.promodsX, config.promodsY, config.logoWidth, config.logoHeight);
      }
      if (dbusworldImg && dbusworldToggleInput.checked) {
        const dbusworldY = promodsToggleInput.checked ? config.dbusworldY : config.promodsY;
        ctx.drawImage(dbusworldImg, config.dbusworldX, dbusworldY, config.logoWidth, config.logoHeight);
      }

      const starMap = {
        "https://truckersmp.com/user/627943": 2,
        "https://truckersmp.com/user/5441056": 1,
        "https://truckersmp.com/user/5429829": 3,
        "https://truckersmp.com/user/5408877": 1,
        "https://truckersmp.com/user/5379466": 3,
        "https://truckersmp.com/user/5861450": 2,
        "https://truckersmp.com/user/4690862": 3,
        "https://truckersmp.com/user/1432064": 2,
        "https://truckersmp.com/user/4890784": 2
      };
      const starsCount = starMap[truckersmpLink] || 0;
      if (starsCount > 0) {
        ctx.font = `bold 24px ${config.font}`;
        ctx.fillStyle = "#FFD700";
        ctx.textAlign = "right";
        const starX = canvas.width - 20;
        for (let i = 0; i < starsCount; i++) {
          const starY = config.promodsY + i * 24;
          ctx.fillText("★", starX, starY);
        }
      }

      const titleText = isNicknameUnlocked && titleToggleInput.checked ? t.titleComedic : t.titleNormal;
      const titleY = canvas.height - 5;
      ctx.font = `bold 22px ${config.font}`;
      ctx.fillStyle = "rgb(240, 240, 240)";
      ctx.textAlign = "center";
      ctx.textBaseline = "bottom";
      ctx.shadowColor = "rgb(0, 0, 0)";
      ctx.shadowOffsetX = 1;
      ctx.shadowOffsetY = 1;
      ctx.shadowBlur = 2;
      ctx.fillText(titleText, canvas.width / 2, titleY);
      ctx.shadowColor = "transparent";

      if (isTruckersMPLinkValid) {
        const qrPersonal = new QRious({
          value: truckersmpLink,
          size: config.qrSize,
          level: 'H'
        });
        const qrPersonalCanvas = document.createElement("canvas");
        qrPersonalCanvas.width = config.qrSize;
        qrPersonalCanvas.height = config.qrSize;
        const qrPersonalCtx = qrPersonalCanvas.getContext("2d");
        qrPersonalCtx.drawImage(qrPersonal.canvas, 0, 0);
        ctx.drawImage(qrPersonalCanvas, config.qrX, config.qrY, config.qrSize, config.qrSize);

        if (idImg) {
          ctx.drawImage(idImg, config.qrX + config.qrSize + config.qrSpacing, config.qrY, config.qrSize, config.qrSize);
        }

        if (leftQrImg) {
          ctx.drawImage(leftQrImg, config.qrX - config.qrSize - config.qrSpacing, config.qrY, config.qrSize, config.qrSize);
        }
      }

      updateDownloadLink();
      console.log("Canvas redraw complete for empresa:", empresa, "language:", currentLanguage, "hue:", hueRotate, "template:", templateImgSrc);
    }

    function updateDownloadLink() {
      const enlace = document.getElementById("descargar");
      const nombre = nombreInput.value || "unknown";
      const empresa = empresaInput.value;
      try {
        enlace.href = canvas.toDataURL("image/png");
        enlace.download = `driver_license_${nombre}_${empresa}.png`;
        console.log("Download link updated successfully");
      } catch (error) {
        console.error("Failed to update download link due to tainted canvas:", error);
        enlace.href = "#";
        enlace.download = "";
        console.warn("Download functionality disabled due to CORS issue");
      }
    }

    fotoInput.addEventListener("change", (e) => {
      console.log("fotoInput changed");
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = (event) => {
          userImage = new Image();
          userImage.src = event.target.result;
          userImage.onload = debouncedGenerarImagen;
        };
        reader.readAsDataURL(file);
      } else {
        userImage = null;
        debouncedGenerarImagen();
      }
    });

    truckersmpLinkInput.addEventListener("input", () => {
      const link = truckersmpLinkInput.value.trim();
      if (link) {
        validateTruckersMPLink(link);
      } else {
        truckersmpStatus.textContent = "";
        truckersmpStatus.className = "";
      }
      debouncedGenerarImagen();
    });

    languageToggle.addEventListener("change", () => {
      updateLanguage(languageToggle.value);
    });

    colorSlider.addEventListener("input", () => {
      console.log(`Color slider changed to: ${colorSlider.value}`);
      colorValue.textContent = `${colorSlider.value}°`;
      debouncedGenerarImagen();
    });

    infoTooltip.addEventListener("click", () => {
      alert(translations[currentLanguage].tooltipMessage);
    });

    const debouncedGenerarImagen = debounce(generarImagen, 200);

    [nombreInput, paisInput, nicknameInput, empresaLinkInput, titleToggleInput, promodsToggleInput, dbusworldToggleInput]
      .forEach(el => el.addEventListener("input", (e) => {
        console.log(`Input event on ${el.id}`);
        debouncedGenerarImagen();
      }));
    paisInput.addEventListener("change", saveDefaultCountry);
    empresaInput.addEventListener("change", updateForm);
    nombreInput.addEventListener("input", updateForm);

    async function initialize() {
      console.log("Initializing");
      loadDefaultCountry();
      nicknameGroup.classList.toggle("hidden", !isNicknameUnlocked);
      titleToggleGroup.classList.toggle("hidden", !isNicknameUnlocked);
      updateLanguage(currentLanguage);
      updateForm();
      await debouncedGenerarImagen();
    }

    initialize();
  </script>
</body>
</html>
