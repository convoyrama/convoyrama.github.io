<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title id="pageTitle">Convoyrama | Generador de Licencia</title>
  <meta name="description" content="Convoyrama">
  <link rel="stylesheet" href="../assets/style.css">
  <link rel="icon" href="../assets/images/favicon.png">
  <link rel="apple-touch-icon" href="../assets/images/favicon.png">
  <!-- Librería para generar códigos QR -->
  <script src="https://cdn.jsdelivr.net/npm/qrious@4.0.2/dist/qrious.min.js"></script>
  <!-- Librería para renderizar emojis -->
  <script src="https://twemoji.maxcdn.com/v/latest/twemoji.min.js" crossorigin="anonymous"></script>
  <style>
    /* Definición de fuentes personalizadas */
    @font-face {font-family:'Verdana';src:url('./verdana/Verdana.ttf') format('truetype');font-weight:400;font-style:normal;}
    @font-face {font-family:'Verdana-Bold';src:url('./verdana/Verdana-Bold.ttf') format('truetype');font-weight:700;font-style:normal;}
    @font-face {font-family:'Verdana-Italic';src:url('./verdana/Verdana-Italic.ttf') format('truetype');font-weight:400;font-style:italic;}
    @font-face {font-family:'Verdana-BoldItalic';src:url('./verdana/Verdana-BoldItalic.ttf') format('truetype');font-weight:700;font-style:italic;}
    /* Estilos para el encabezado */
    header {padding:15px;text-align:center;position:relative;z-index:10;background:var(--accent-bg);border-bottom:1px solid var(--border);}
    header p {font-size:1.2em;text-shadow:none;font-family:Arial,sans-serif;font-weight:normal;margin:10px 0;color:#fff;}
    nav {padding:10px;text-align:center;}
    nav a,nav a:visited {text-decoration:none;margin:0 15px;font-size:1em;text-shadow:none;color:#fff;}
    nav a:hover {text-decoration:underline;}
    /* Contenedor principal con layout flexible */
    .contenedor {display:flex;gap:15px;padding:15px;align-items:flex-start;font-family:Arial,sans-serif;}
    .panel {flex:1;max-width:250px;font-size:13px;}
    .panel h3 {margin:10px 0 5px;font-size:13px;}
    .input-group {margin:5px 0;}
    /* Estilos para inputs y selects */
    .input-group input,
    .input-group select {
      width:230px;
      box-sizing:border-box;
      padding:8px;
      font-size:13px;
      border:1px solid #ccc;
      border-radius:4px;
    }
    input[type="file"] {
      width:230px;
      box-sizing:border-box;
      font-size:13px;
      border:none;
      padding:8px 0;
    }
    .toggle-item {margin:5px 0;}
    .toggle-item input[type="checkbox"] {margin-right:5px;}
    /* Estilos para el grupo de toggles en la misma línea */
    .toggle-group {
      display: flex;
      gap: 20px;
      align-items: center;
      margin: 5px 0;
    }
    /* Estilos para el canvas de la licencia */
    canvas {border:1px solid #000;display:block;max-width:100%;height:auto;}
    #preview {flex:1;text-align:center;}
    /* Estilos para botones */
    button {padding:5px 10px;font-size:13px;margin-top:8px;background:rgb(90,165,25);color:#fff;border:none;border-radius:6px;cursor:pointer;}
    button:hover {opacity:0.8;}
    button.info-tooltip:hover::after {content:attr(data-tooltip);position:absolute;bottom:100%;left:50%;transform:translateX(-50%);background:#333;color:#fff;padding:5px 10px;border-radius:4px;font-size:12px;white-space:nowrap;z-index:10;}
    .hidden {display:none;}
    /* Estilos para mensajes de validación */
    #truckersmpStatus,#empresaLinkStatus {font-size:11px;color:#555;margin-top:5px;}
    .valid {color:green;}
    .invalid {color:red;}
    /* Estilos para el slider de color */
    #colorSlider {
      width:80%;
      margin-top:5px;
      vertical-align:middle;
      height:6px; /* Reducido para un aspecto más fino */
      background:#e0e0e0;
      border-radius:3px;
      outline:none;
      transition:background 0.3s;
    }
    #colorSlider::-webkit-slider-thumb {
      -webkit-appearance:none;
      appearance:none;
      width:16px; /* Thumb más pequeño */
      height:16px;
      background:rgb(90,165,25);
      border-radius:50%;
      cursor:pointer;
      transition:background 0.3s;
    }
    #colorSlider::-webkit-slider-thumb:hover {
      background:rgb(70,130,20);
    }
    #colorSlider::-moz-range-thumb {
      width:16px;
      height:16px;
      background:rgb(90,165,25);
      border-radius:50%;
      cursor:pointer;
      border:none;
      transition:background 0.3s;
    }
    #colorSlider::-moz-range-thumb:hover {
      background:rgb(70,130,20);
    }
    #colorValue {display:inline-block;width:15%;text-align:right;font-size:13px;color:#555;}
    footer {margin:8px 0;}
  </style>
</head>
<body>
  <!-- Encabezado con navegación -->
  <header>
    <nav>
      <a href="../index.html">Home</a>
      <a href="pc.html">Creador de Perfil</a>
      <a href="id.html" id="navLicense">Licencia</a>
    </nav>
    <p id="headerTitle">Generador de Licencia de Conductor</p>
  </header>
  <!-- Contenedor principal con panel de inputs y vista previa -->
  <div class="contenedor">
    <div class="panel">
      <!-- Selección de idioma -->
      <div class="input-group">
        <label for="languageToggle">Idioma / Language / Língua:</label><br>
        <select id="languageToggle">
          <option value="es">Español</option>
          <option value="en">English</option>
          <option value="pt">Português</option>
        </select>
      </div>
      <!-- Campo para título personalizado -->
      <div class="input-group">
        <label for="customTitle" id="customTitleLabel">Cambiar título:</label><br>
        <input type="text" id="customTitle" maxlength="36" placeholder="Título personalizado (máx. 36 caracteres, opcional)">
      </div>
      <!-- Campo para el nombre -->
      <div class="input-group">
        <label for="nombre" id="nameLabel">Nombre:</label><br>
        <input type="text" id="nombre" placeholder="Nombre / Name / Nome" required>
      </div>
      <!-- Selección de país -->
      <div class="input-group">
        <label for="pais" id="countryLabel">País:</label><br>
        <select id="pais" required>
          <option value="">Seleccione un país / Select a country / Selecione um país</option>
          <option value="AR|🇦🇷|Argentina|Argentina|Argentina">🇦🇷 Argentina</option>
          <option value="AU|🇦🇺|Australia|Australia|Austrália">🇦🇺 Australia</option>
          <option value="BO|🇧🇴|Bolivia|Bolivia|Bolívia">🇧🇴 Bolivia</option>
          <option value="BR|🇧🇷|Brasil|Brazil|Brasil">🇧🇷 Brasil</option>
          <option value="CA|🇨🇦|Canadá|Canada|Canadá">🇨🇦 Canadá</option>
          <option value="CL|🇨🇱|Chile|Chile|Chile">🇨🇱 Chile</option>
          <option value="CN|🇨🇳|China|China|China">🇨🇳 China</option>
          <option value="CO|🇨🇴|Colombia|Colombia|Colômbia">🇨🇴 Colombia</option>
          <option value="CU|🇨🇺|Cuba|Cuba|Cuba">🇨🇺 Cuba</option>
          <option value="DE|🇩🇪|Alemania|Germany|Alemanha">🇦🇩 Alemania</option>
          <option value="EC|🇪🇨|Ecuador|Ecuador|Equador">🇪🇨 Ecuador</option>
          <option value="ES|🇪🇸|España|Spain|Espanha">🇪🇸 España</option>
          <option value="FR|🇫🇷|Francia|France|França">🇫🇷 Francia</option>
          <option value="GB|🇬🇧|Reino Unido|United Kingdom|Reino Unido">🇬🇧 Reino Unido</option>
          <option value="IN|🇮🇳|India|India|Índia">🇮🇳 India</option>
          <option value="IT|🇮🇹|Italia|Italy|Itália">🇮🇹 Italia</option>
          <option value="JP|🇯🇵|Japón|Japan|Japão">🇯🇵 Japón</option>
          <option value="MX|🇲🇽|México|Mexico|México">🇲🇽 México</option>
          <option value="PE|🇵🇪|Perú|Peru|Peru">🇵🇪 Perú</option>
          <option value="PY|🇵🇾|Paraguay|Paraguay|Paraguai">🇵🇾 Paraguay</option>
          <option value="RU|🇷🇺|Rusia|Russia|Rússia">🇷🇺 Rusia</option>
          <option value="US|🇺🇸|Estados Unidos|United States|Estados Unidos">🇺🇸 Estados Unidos</option>
          <option value="UY|🇺🇾|Uruguay|Uruguay|Uruguai">🇺🇾 Uruguay</option>
          <option value="VE|🇻🇪|Venezuela|Venezuela|Venezuela">🇻🇪 Venezuela</option>
          <option value="AD|🇦🇩|Andorra|Andorra|Andorra">🇦🇩 Andorra</option>
          <option value="PI|🏴‍☠️|Pirata|Pirate|Pirata">🏴‍☠️ Pirata</option>
        </select>
      </div>
      <!-- Campo para enlace de perfil en TruckersMP -->
      <div class="input-group">
        <label for="truckersmpLink" id="truckersmpLinkLabel">Enlace Perfil en TMP:</label><br>
        <input type="text" id="truckersmpLink" placeholder="TruckersMP Profile Link" required>
        <div id="truckersmpStatus"></div>
      </div>
      <!-- Campo para enlace de empresa en TruckersMP -->
      <div class="input-group">
        <label for="empresaLink" id="companyLinkLabel">Enlace Perfil Empresa en TMP:</label><br>
        <input type="text" id="empresaLink" placeholder="TruckersMP Company Profile Link" required>
        <div id="empresaLinkStatus"></div>
      </div>
      <!-- Campo para subir una foto -->
      <div class="input-group">
        <label for="foto" id="photoLabel">Foto (Opcional):</label><br>
        <input type="file" id="foto" accept="image/*">
      </div>
      <!-- Selección de TAG épico (oculta por defecto) -->
      <div class="input-group hidden" id="nicknameGroup">
        <label for="nickname" id="nicknameLabel">TAG Épico:</label><br>
        <select id="nickname">
          <option value="">Seleccione un TAG</option>
          <option value="ReyDelLag">ReyDelLag</option>
          <option value="FrenadorEnCurva">FrenadorEnCurva</option>
          <option value="SeñorDelLagazo">SeñorDelLagazo</option>
          <option value="BocinaLoca">BocinaLoca</option>
          <option value="CargadorDeDeudas">CargadorDeDeudas</option>
          <option value="CamioneroDelApagón">CamioneroDelApagón</option>
          <option value="FugitivoDeLaRuta">FugitivoDeLaRuta</option>
          <option value="MaestroDelPing">MaestroDelPing</option>
          <option value="ReyDeLaCarretera">ReyDeLaCarretera</option>
          <option value="LocoDelVolante">LocoDelVolante</option>
          <option value="SobrevivienteDelBan">SobrevivienteDelBan</option>
          <option value="BanEvasor">BanEvasor</option>
          <option value="FrenazoEstelar">FrenazoEstelar</option>
          <option value="TerrorDeCalais">TerrorDeCalais</option>
          <option value="LagLegendario">LagLegendario</option>
          <option value="SobrevivienteDeKirkenes">SobrevivienteDeKirkenes</option>
          <option value="MaestroDelReckless">MaestroDelReckless</option>
          <option value="PingParalizante">PingParalizante</option>
          <option value="RutaSinRetorno">RutaSinRetorno</option>
          <option value="VolanteEndemoniado">VolanteEndemoniado</option>
          <option value="AsDelReporte">AsDelReporte</option>
          <option value="ReyDeDuisburg">ReyDeDuisburg</option>
          <option value="ReyDeCalais">ReyDeCalais</option>
          <option value="KaosEnLaRuta">KaosEnLaRuta</option>
          <option value="CarreteraPerdida">CarreteraPerdida</option>
          <option value="FrenadorDePánico">FrenadorDePánico</option>
          <option value="CargaConDrama">CargaConDrama</option>
        </select>
      </div>
      <!-- Checkbox para usar título cómico (oculta por defecto) -->
      <div class="toggle-item hidden" id="titleToggleGroup">
        <label for="titleToggle" id="titleToggleLabel">Usar título cómico:</label><br>
        <input type="checkbox" id="titleToggle">
      </div>
      <!-- Grupo de toggles para ProMods y DBusWorld -->
      <div class="toggle-group">
        <!-- Checkbox para incluir logo de ProMods -->
        <div class="toggle-item">
          <label for="promodsToggle">ProMods:</label>
          <input type="checkbox" id="promodsToggle">
        </div>
        <!-- Checkbox para incluir logo de DBusWorld -->
        <div class="toggle-item">
          <label for="dbusworldToggle">DBUS:</label>
          <input type="checkbox" id="dbusworldToggle">
        </div>
      </div>
    </div>
    <!-- Área de vista previa con canvas, deslizador de tono y botón de descarga -->
    <div id="preview">
      <canvas id="canvas" width="800" height="500"></canvas>
      <!-- Slider para ajustar el tono del fondo -->
      <div class="input-group">
        <label for="colorSlider" id="colorLabel">Tono del fondo:</label><br>
        <input type="range" id="colorSlider" min="0" max="360" value="0">
        <span id="colorValue">0°</span>
      </div>
      <br>
      <a id="descargar" download="driver_license.png">
        <button id="botonDescargar" class="info-tooltip" data-tooltip="Esta licencia es una broma y un guiño a la comunidad, no pretende ser profesional ni seria.">Descargar Licencia</button>
      </a>
    </div>
  </div>
  <footer><small>© LAG'S SPEED - CONVOYRAMA 2025 - v1.1</small></footer>
  <script>
    // Obtiene el canvas y su contexto 2D
    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d");

    // Configuración de coordenadas y tamaños para elementos en el canvas
    const config = {
      color: "white",
      flagSize: 80,
      photoX: 45,
      photoY: 80,
      labelX: 100,
      colonX: 130,
      textX: 295,
      textY: 334,
      qrX: 573,
      qrY: 101,
      flagX: 625,
      flagY: 206,
      font: "'Verdana', sans-serif",
      defaultPhotoSize: 192,
      qrSize: 100,
      qrSpacing: 10,
      promodsX: 20,
      promodsY: 334,
      dbusworldX: 20,
      dbusworldY: 394,
      logoWidth: 67,
      logoHeight: 50,
      vtcLogoSize: 100
    };

    // Mapa de enlaces de empresas VTC a sus respectivos logos
    const vtcMap = {
      "https://truckersmp.com/vtc/78865": "ls.png",
      "https://truckersmp.com/vtc/76978": "tcs.png",
      "https://truckersmp.com/vtc/55250-andesvtc": "andes.png",
      "https://truckersmp.com/vtc/55250": "andes.png",
      "https://truckersmp.com/vtc/29591": "castores.jpg",
      "https://truckersmp.com/vtc/81636": "chapu.jpeg",
      "https://truckersmp.com/vtc/55439-destiny": "destiny.png",
      "https://truckersmp.com/vtc/55439": "destiny.png",
      "https://truckersmp.com/vtc/56572-lsavtc": "lsa.png",
      "https://truckersmp.com/vtc/56572": "lsa.png",
      "https://truckersmp.com/vtc/79357": "norte.png",
      "https://truckersmp.com/vtc/34966-nova-era": "nova.png",
      "https://truckersmp.com/vtc/34966": "nova.png",
      "https://truckersmp.com/vtc/64312": "shipeados.png",
      "https://truckersmp.com/vtc/65011": "tl.png",
      "https://truckersmp.com/vtc/17910-transportesatr": "atr.png",
      "https://truckersmp.com/vtc/17910": "atr.png",
      "https://truckersmp.com/vtc/63758": "cord.jpg",
      "https://truckersmp.com/vtc/48970": "sin.jpg",
      "https://truckersmp.com/vtc/70703": "as.png",
      "https://truckersmp.com/vtc/77802": "ex.png",
      "https://truckersmp.com/vtc/62448": "rut.jpg",
      "https://truckersmp.com/vtc/11715": "avant.png",
      "https://truckersmp.com/vtc/76975": "titan.png",
      "https://truckersmp.com/vtc/3414": "baltico.png",
      "https://truckersmp.com/vtc/79130": "corr.png",
      "https://truckersmp.com/vtc/74222": "esp.jpg",
      "https://truckersmp.com/vtc/63303": "coo.png",
      "https://truckersmp.com/vtc/1271": "ali.png",
      "https://truckersmp.com/vtc/50578": "tcc.png",
      "https://truckersmp.com/vtc/56350": "gaat.png",
      "https://truckersmp.com/vtc/2436": "go.png"
    };

    // Traducciones para los textos de la interfaz en diferentes idiomas
    const translations = {
      es: {
        pageTitle: "Convoyrama | Generador de Licencia",
        headerTitle: "Generador de Licencia de Conductor",
        navLicense: "Licencia",
        nameLabel: "Nombre:",
        nicknameLabel: "TAG Épico:",
        titleToggleLabel: "Usar título cómico:",
        photoLabel: "Foto (Opcional):",
        countryLabel: "País:",
        companyLinkLabel: "Enlace Perfil Empresa en TMP:",
        truckersmpLinkLabel: "Enlace Perfil en TMP:",
        customTitleLabel: "Cambiar título:",
        customTitlePlaceholder: "Título personalizado (máx. 36 caracteres, opcional)",
        validLink: "Enlace válido",
        invalidLink: "Enlace inválido: debe ser https://truckersmp.com/user/[...]",
        validCompanyLink: "Enlace de empresa válido",
        invalidCompanyLink: "Enlace inválido: debe ser https://truckersmp.com/vtc/[...]",
        downloadButton: "Descargar Licencia",
        canvasName: "Nombre :",
        canvasLicenseNo: "Núm. Licencia :",
        canvasDate: "Fecha :",
        canvasCountry: "País :",
        canvasTag: "TAG :",
        titleNormal: "PERMISO DE CONDUCCIÓN INTERNACIONAL",
        titleComedic: "PERMISO PARA CHOCAR EN CONVOY",
        countryPlaceholder: "Seleccione un país",
        colorLabel: "Tono del fondo:",
        tooltipMessage: "Esta licencia es una broma y un guiño a la comunidad, no pretende ser profesional ni seria."
      },
      en: {
        pageTitle: "Convoyrama | Driver License Generator",
        headerTitle: "Driver License Generator",
        navLicense: "License",
        nameLabel: "Name:",
        nicknameLabel: "Epic TAG:",
        titleToggleLabel: "Use comedic title:",
        photoLabel: "Photo (Optional):",
        countryLabel: "Country:",
        companyLinkLabel: "TruckersMP Company Profile Link:",
        truckersmpLinkLabel: "TruckersMP Profile Link:",
        customTitleLabel: "Change title:",
        customTitlePlaceholder: "Custom title (max 36 characters, optional)",
        validLink: "Valid link",
        invalidLink: "Invalid link: must be https://truckersmp.com/user/[...]",
        validCompanyLink: "Valid company link",
        invalidCompanyLink: "Invalid link: must be https://truckersmp.com/vtc/[...]",
        downloadButton: "Download License",
        canvasName: "Name :",
        canvasLicenseNo: "License No. :",
        canvasDate: "Date :",
        canvasCountry: "Country :",
        canvasTag: "TAG :",
        titleNormal: "INTERNATIONAL DRIVING LICENSE",
        titleComedic: "CONVOY CRASHING PERMIT",
        countryPlaceholder: "Select a country",
        colorLabel: "Background hue:",
        tooltipMessage: "This license is a joke and a nod to the community, not intended to be professional or serious."
      },
      pt: {
        pageTitle: "Convoyrama | Gerador de Licença",
        headerTitle: "Gerador de Licença de Motorista",
        navLicense: "Licença",
        nameLabel: "Nome:",
        nicknameLabel: "TAG Épico:",
        titleToggleLabel: "Usar título cômico:",
        photoLabel: "Foto (Opcional):",
        countryLabel: "País:",
        companyLinkLabel: "Link do Perfil da Empresa no TruckersMP:",
        truckersmpLinkLabel: "Link do Perfil no TruckersMP:",
        customTitleLabel: "Alterar título:",
        customTitlePlaceholder: "Título personalizado (máx. 36 caracteres, opcional)",
        validLink: "Link válido",
        invalidLink: "Link inválido: deve ser https://truckersmp.com/user/[...]",
        validCompanyLink: "Link de empresa válido",
        invalidCompanyLink: "Link inválido: deve ser https://truckersmp.com/vtc/[...]",
        downloadButton: "Baixar Licença",
        canvasName: "Nome :",
        canvasLicenseNo: "Nº da Licença :",
        canvasDate: "Data :",
        canvasCountry: "País :",
        canvasTag: "TAG :",
        titleNormal: "LICENÇA INTERNACIONAL DE CONDUÇÃO",
        titleComedic: "PERMISSÃO PARA CAUSAR CAOS EM COMBOIO",
        countryPlaceholder: "Selecione um país",
        colorLabel: "Tom do fundo:",
        tooltipMessage: "Esta licença é uma brincadeira e uma homenagem à comunidade, não pretende ser profissional ou séria."
      }
    };

    // Referencias a los elementos del DOM
    const nameInput = document.getElementById("nombre");
    const photoInput = document.getElementById("foto");
    const countrySelect = document.getElementById("pais");
    const nicknameSelect = document.getElementById("nickname");
    const companyLinkInput = document.getElementById("empresaLink");
    const truckersmpLinkInput = document.getElementById("truckersmpLink");
    const truckersmpStatus = document.getElementById("truckersmpStatus");
    const companyLinkStatus = document.getElementById("empresaLinkStatus");
    const nicknameGroup = document.getElementById("nicknameGroup");
    const titleToggleGroup = document.getElementById("titleToggleGroup");
    const titleToggleInput = document.getElementById("titleToggle");
    const promodsToggleInput = document.getElementById("promodsToggle");
    const dbusworldToggleInput = document.getElementById("dbusworldToggle");
    const languageSelect = document.getElementById("languageToggle");
    const colorSlider = document.getElementById("colorSlider");
    const colorValue = document.getElementById("colorValue");
    const downloadButton = document.getElementById("botonDescargar");
    const customTitleInput = document.getElementById("customTitle");

    // Variables globales
    let userImage = null; // Imagen cargada por el usuario
    let isNicknameUnlocked = localStorage.getItem("nicknameUnlocked") === "true"; // Estado del desbloqueo del TAG épico
    let currentDate = null; // Caché de la fecha actual
    let lastDateFetch = 0; // Timestamp del último fetch de fecha
    let isDateFromInternet = false; // Indicador de si la fecha proviene de internet
    const DATE_CACHE_DURATION = 180000; // Duración del caché de fecha (3 minutos)
    let currentLanguage = "es"; // Idioma actual
    let lastFormState = {}; // Estado anterior del formulario para evitar redibujar innecesariamente

    // Carga una imagen de emoji desde Twemoji
    async function renderTwemoji(emoji, size) {
      return new Promise(resolve => {
        const img = new Image();
        img.crossOrigin = "anonymous";
        img.onload = () => resolve(img);
        img.src = twemoji.parse(emoji, { folder: 'svg', ext: '.svg' }).match(/src="([^"]+)"/)?.[1] || "";
      });
    }

    // Obtiene la fecha actual desde APIs externas o localmente
    async function getCurrentDate() {
      const now = Date.now();
      if (currentDate && now - lastDateFetch < DATE_CACHE_DURATION) {
        return currentDate;
      }
      const apis = [
        {
          url: 'https://worldtimeapi.org/api/timezone/Etc/UTC',
          parse: data => {
            const date = new Date(data.datetime);
            return {
              day: date.getDate().toString().padStart(2, "0"),
              month: (date.getMonth() + 1).toString().padStart(2, "0"),
              year: date.getFullYear()
            };
          }
        },
        {
          url: 'https://timeapi.io/api/Time/current/utc',
          parse: data => ({
            day: data.day.toString().padStart(2, "0"),
            month: data.month.toString().padStart(2, "0"),
            year: data.year
          })
        },
        {
          url: 'https://worldclockapi.herokuapp.com/api/json/utc/now',
          parse: data => {
            const date = new Date(data.currentDateTime);
            return {
              day: date.getDate().toString().padStart(2, "0"),
              month: (date.getMonth() + 1).toString().padStart(2, "0"),
              year: date.getFullYear()
            };
          }
        }
      ];
      for (const api of apis) {
        try {
          const response = await fetch(api.url);
          const data = await response.json();
          const { day, month, year } = api.parse(data);
          currentDate = `${day}/${month}/${year}`;
          lastDateFetch = now;
          isDateFromInternet = true; // Fecha obtenida de internet
          return currentDate;
        } catch (error) {}
      }
      const date = new Date();
      currentDate = `${date.getDate().toString().padStart(2, "0")}/${(date.getMonth() + 1).toString().padStart(2, "0")}/${date.getFullYear()}`;
      lastDateFetch = now;
      isDateFromInternet = false; // Fecha obtenida localmente
      return currentDate;
    }

    // Actualiza la interfaz al cambiar el idioma, incluyendo nombres de países en el selector
    function updateLanguage(lang) {
      currentLanguage = lang;
      const trans = translations[lang];
      const nameIndex = { es: 2, en: 3, pt: 4 }[lang];
      document.getElementById("pageTitle").textContent = trans.pageTitle;
      document.getElementById("headerTitle").textContent = trans.headerTitle;
      document.getElementById("navLicense").textContent = trans.navLicense;
      document.getElementById("nameLabel").textContent = trans.nameLabel;
      document.getElementById("nicknameLabel").textContent = trans.nicknameLabel;
      document.getElementById("titleToggleLabel").textContent = trans.titleToggleLabel;
      document.getElementById("photoLabel").textContent = trans.photoLabel;
      document.getElementById("countryLabel").textContent = trans.countryLabel;
      document.getElementById("companyLinkLabel").textContent = trans.companyLinkLabel;
      document.getElementById("truckersmpLinkLabel").textContent = trans.truckersmpLinkLabel;
      document.getElementById("customTitleLabel").textContent = trans.customTitleLabel;
      document.getElementById("colorLabel").textContent = trans.colorLabel;
      document.getElementById("botonDescargar").textContent = trans.downloadButton;
      document.getElementById("botonDescargar").setAttribute("data-tooltip", trans.tooltipMessage);
      countrySelect.options[0].text = trans.countryPlaceholder;
      customTitleInput.placeholder = trans.customTitlePlaceholder;
      // Actualizar textos de opciones de países según el idioma
      for (let i = 1; i < countrySelect.options.length; i++) {
        const opt = countrySelect.options[i];
        const data = opt.value.split("|");
        opt.text = data[1] + " " + data[nameIndex];
      }
      const truckersmpLink = truckersmpLinkInput.value.trim();
      const companyLink = companyLinkInput.value.trim();
      if (truckersmpLink) validateTruckersmpLink(truckersmpLink);
      if (companyLink) validateCompanyLink(companyLink);
      debouncedGenerateImage();
    }

    // Genera el número de licencia combinando el código del país y el ID del usuario
    function generateLicenseNumber(name, country, truckersmpLink) {
      const countryCode = country.split("|")[0].substring(0, 2) || "XX";
      let userId = "";
      if (truckersmpLink) {
        const match = truckersmpLink.match(/truckersmp\.com\/user\/(.+)/);
        userId = match ? match[1] : "";
      }
      return userId ? `${countryCode}${userId}` : "";
    }

    // Valida el enlace del perfil de TruckersMP
    function validateTruckersmpLink(link) {
      const regex = /^https:\/\/truckersmp\.com\/user\/.+$/;
      const trans = translations[currentLanguage];
      if (!regex.test(link)) {
        truckersmpStatus.textContent = trans.invalidLink;
        truckersmpStatus.className = "invalid";
        return false;
      }
      truckersmpStatus.textContent = trans.validLink;
      truckersmpStatus.className = "valid";
      return true;
    }

    // Valida el enlace de la empresa VTC
    function validateCompanyLink(link) {
      const regex = /^https:\/\/truckersmp\.com\/vtc\/.+$/;
      const trans = translations[currentLanguage];
      if (!regex.test(link)) {
        companyLinkStatus.textContent = trans.invalidCompanyLink;
        companyLinkStatus.className = "invalid";
        return false;
      }
      companyLinkStatus.textContent = trans.validCompanyLink;
      companyLinkStatus.className = "valid";
      return true;
    }

    // Función de debounce para retrasar la ejecución y evitar llamadas excesivas
    function debounce(func, wait) {
      let timeout;
      return function (...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }

    // Guarda el país seleccionado en localStorage
    function saveDefaultCountry() {
      localStorage.setItem("defaultCountry", countrySelect.value);
    }

    // Carga el país guardado desde localStorage
    function loadDefaultCountry() {
      const savedCountry = localStorage.getItem("defaultCountry");
      if (savedCountry) countrySelect.value = savedCountry;
    }

    // Actualiza el estado del formulario (desbloqueo de TAG, título cómico y color)
    function updateForm() {
      const name = nameInput.value.toLowerCase().trim();
      if (name === "resetnick") {
        isNicknameUnlocked = false;
        localStorage.removeItem("nicknameUnlocked");
      } else if (["convoyrama", "nocturnoverso"].includes(name)) {
        isNicknameUnlocked = true;
        localStorage.setItem("nicknameUnlocked", "true");
      }
      nicknameGroup.classList.toggle("hidden", !isNicknameUnlocked);
      titleToggleGroup.classList.toggle("hidden", !isNicknameUnlocked);
      const companyLink = companyLinkInput.value.trim();
      const colorMap = {
        "https://truckersmp.com/vtc/78865": 260,
        "https://truckersmp.com/vtc/76978": 200
      };
      const newColor = colorMap[companyLink] || colorSlider.value;
      colorSlider.value = newColor;
      colorValue.textContent = `${newColor}°`;
      if (companyLink) validateCompanyLink(companyLink);
      debouncedGenerateImage();
    }

    // Obtiene el estado actual del formulario
    function getFormState() {
      return {
        name: nameInput.value,
        country: countrySelect.value,
        nickname: nicknameSelect.value,
        truckersmpLink: truckersmpLinkInput.value,
        companyLink: companyLinkInput.value,
        titleToggle: titleToggleInput.checked,
        promodsToggle: promodsToggleInput.checked,
        dbusworldToggle: dbusworldToggleInput.checked,
        userImage: userImage ? userImage.src : null,
        language: currentLanguage,
        colorHue: colorSlider.value,
        customTitle: customTitleInput.value
      };
    }

    // Genera la imagen de la licencia en el canvas
    async function generateImage() {
      const formState = getFormState();
      if (JSON.stringify(formState) === JSON.stringify(lastFormState)) return;
      lastFormState = formState;

      const trans = translations[currentLanguage];
      const nameIndex = { es: 2, en: 3, pt: 4 }[currentLanguage];
      const name = nameInput.value || (currentLanguage === "es" ? "Sin nombre" : currentLanguage === "en" ? "No name" : "Sem nome");
      const countryData = countrySelect.value.split("|");
      const countryCode = countryData[0] || "XX";
      const flagEmoji = countryData[1] || "";
      const countryName = countryData[nameIndex] || (currentLanguage === "es" ? "Sin país" : currentLanguage === "en" ? "No country" : "Sem país");
      const nickname = nicknameSelect.value || "";
      const truckersmpLink = truckersmpLinkInput.value.trim();
      const companyLink = companyLinkInput.value.trim();
      const isTruckersmpValid = truckersmpLink ? validateTruckersmpLink(truckersmpLink) : false;
      const isCompanyValid = companyLink ? validateCompanyLink(companyLink) : false;
      const hueRotate = parseInt(colorSlider.value);

      // Configura el canvas
      canvas.width = 800;
      canvas.height = 500;
      ctx.imageSmoothingEnabled = true;
      ctx.imageSmoothingQuality = "high";
      ctx.save();
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.font = null;
      ctx.fillStyle = null;
      ctx.textAlign = "start";
      ctx.textBaseline = "alphabetic";
      ctx.shadowColor = "transparent";
      ctx.globalCompositeOperation = "source-over";

      // Carga las imágenes necesarias
      const templateImage = new Image();
      templateImage.src = "./assets/images/license_template.png";
      const languageImageSrc = { es: './assets/images/es.png', en: './assets/images/en.png', pt: './assets/images/pt.png' }[currentLanguage];
      const languageImage = new Image();
      languageImage.src = languageImageSrc;
      const vtcImageSrc = companyLink && vtcMap[companyLink] ? `./assets/images/vtc/${vtcMap[companyLink]}` : null;
      const vtcImage = vtcImageSrc ? new Image() : null;
      if (vtcImage) vtcImage.src = vtcImageSrc;

      const [templateImg, languageImg, defaultPhoto, flagImg, idImg, promodsImg, dbusworldImg, vtcLogoImg] = await Promise.all([
        new Promise(resolve => {
          templateImage.onload = () => resolve(templateImage);
          templateImage.onerror = () => resolve(null);
        }),
        new Promise(resolve => {
          languageImage.onload = () => resolve(languageImage);
          languageImage.onerror = () => resolve(null);
        }),
        userImage ? Promise.resolve(null) : renderTwemoji("👤", config.defaultPhotoSize),
        flagEmoji ? renderTwemoji(flagEmoji, config.flagSize) : Promise.resolve(null),
        isTruckersmpValid ? new Promise(resolve => {
          const img = new Image();
          img.src = "./assets/images/id.svg";
          img.onload = () => resolve(img);
          img.onerror = () => resolve(null);
        }) : Promise.resolve(null),
        promodsToggleInput.checked ? new Promise(resolve => {
          const img = new Image();
          img.src = "./assets/images/promods.png";
          img.onload = () => resolve(img);
          img.onerror = () => resolve(null);
        }) : Promise.resolve(null),
        dbusworldToggleInput.checked ? new Promise(resolve => {
          const img = new Image();
          img.src = "./assets/images/dbusworld.png";
          img.onload = () => resolve(img);
          img.onerror = () => resolve(null);
        }) : Promise.resolve(null),
        vtcImage ? new Promise(resolve => {
          vtcImage.onload = () => resolve(vtcImage);
          vtcImage.onerror = () => resolve(null);
        }) : Promise.resolve(null)
      ]);

      // Dibuja la plantilla con filtro de color
      if (templateImg) {
        ctx.filter = `hue-rotate(${hueRotate}deg)`;
        ctx.drawImage(templateImg, 0, 0, 800, 500);
        ctx.filter = "none";
      } else {
        ctx.fillStyle = "#fff";
        ctx.fillRect(0, 0, 800, 500);
      }

      // Dibuja la capa del idioma
      if (languageImg) ctx.drawImage(languageImg, 0, 0, 800, 500);

      // Dibuja el título superior
      ctx.font = "bold 30px 'Verdana-Bold'";
      ctx.fillStyle = "#fff";
      ctx.textAlign = "center";
      ctx.textBaseline = "middle";
      ctx.fillText(customTitleInput.value.trim() || "TRUCKERSMP", 400, 40.77);

      // Dibuja la foto del usuario o el emoji por defecto
      if (userImage) {
        ctx.drawImage(userImage, config.photoX, config.photoY, config.defaultPhotoSize, config.defaultPhotoSize);
      } else if (defaultPhoto) {
        ctx.drawImage(defaultPhoto, config.photoX, config.photoY, config.defaultPhotoSize, config.defaultPhotoSize);
      }

      // Dibuja la bandera del país
      if (flagImg) ctx.drawImage(flagImg, config.flagX - config.flagSize / 2, config.flagY, config.flagSize, config.flagSize);

      // Dibuja el logo de la VTC en la posición original
      if (vtcLogoImg && isCompanyValid) {
        ctx.drawImage(vtcLogoImg, config.qrX - 2 * config.qrSize - 2 * config.qrSpacing, config.qrY, config.vtcLogoSize, config.vtcLogoSize);
      }

      // Dibuja el logo de la VTC en el medio del canvas con opacidad 10%, asumiendo imagen cuadrada
      if (vtcLogoImg && isCompanyValid) {
        ctx.globalAlpha = 0.1;
        const centerX = (canvas.width - 200) / 2 + 150;
        const centerY = (canvas.height - 200) / 2 + 100;
        ctx.drawImage(vtcLogoImg, centerX, centerY, 200, 200);
        ctx.globalAlpha = 1.0;
      }

      // Dibuja los textos en el canvas
      const currentDateStr = await getCurrentDate();
      ctx.font = `bold 24px ${config.font}`;
      ctx.fillStyle = config.color;
      ctx.textAlign = "left";
      ctx.textBaseline = "alphabetic";
      const lineHeight = 24 * 1.2;
      ctx.fillText(trans.canvasName, config.labelX, config.textY);
      ctx.fillText(trans.canvasLicenseNo, config.labelX, config.textY + lineHeight);
      ctx.fillText(trans.canvasDate, config.labelX, config.textY + lineHeight * 2);
      ctx.fillText(trans.canvasCountry, config.labelX, config.textY + lineHeight * 3);
      if (isNicknameUnlocked && nickname) ctx.fillText(trans.canvasTag, config.labelX, config.textY + lineHeight * 4);
      ctx.fillText(name, config.textX, config.textY);
      if (name && name.trim() !== "" && countrySelect.value && isTruckersmpValid) {
        const licenseNumber = generateLicenseNumber(name, countrySelect.value, truckersmpLink);
        if (licenseNumber) ctx.fillText(licenseNumber, config.textX, config.textY + lineHeight);
      }
      ctx.fillText(currentDateStr, config.textX, config.textY + lineHeight * 2);
      // Dibuja el indicador de fuente de fecha (✓ o ✗)
      ctx.fillText(isDateFromInternet ? "✓" : "✗", config.textX + ctx.measureText(currentDateStr).width + 5, config.textY + lineHeight * 2);
      ctx.fillText(countryName, config.textX, config.textY + lineHeight * 3);
      if (isNicknameUnlocked && nickname) ctx.fillText(nickname, config.textX, config.textY + lineHeight * 4);

      // Dibuja los logos de ProMods y DBusWorld
      if (promodsImg && promodsToggleInput.checked) {
        ctx.drawImage(promodsImg, config.promodsX, config.promodsY, config.logoWidth, config.logoHeight);
      }
      if (dbusworldImg && dbusworldToggleInput.checked) {
        const dbusworldY = promodsToggleInput.checked ? config.dbusworldY : config.promodsY;
        ctx.drawImage(dbusworldImg, config.dbusworldX, dbusworldY, config.logoWidth, config.logoHeight);
      }

      // Dibuja estrellas para usuarios específicos
      const starMap = {
        "https://truckersmp.com/user/627943": 2,
        "https://truckersmp.com/user/5441056": 1,
        "https://truckersmp.com/user/5429829": 3,
        "https://truckersmp.com/user/5408877": 1,
        "https://truckersmp.com/user/5379466": 3,
        "https://truckersmp.com/user/5861450": 2,
        "https://truckersmp.com/user/4690862": 3,
        "https://truckersmp.com/user/1432064": 2,
        "https://truckersmp.com/user/4890784": 2
      };
      const starCount = starMap[truckersmpLink] || 0;
      if (starCount > 0) {
        ctx.font = `bold 24px ${config.font}`;
        ctx.fillStyle = "#FFD700";
        ctx.textAlign = "right";
        const starX = 800 - 20;
        for (let i = 0; i < starCount; i++) {
          const starY = config.promodsY + i * 24;
          ctx.fillText("★", starX, starY);
        }
        ctx.filter = "none";
      }

      // Dibuja el título inferior (normal o cómico)
      const titleText = isNicknameUnlocked && titleToggleInput.checked ? trans.titleComedic : trans.titleNormal;
      const titleY = 500 - 5;
      ctx.font = `bold 22px ${config.font}`;
      ctx.fillStyle = "rgb(240,240,240)";
      ctx.textAlign = "center";
      ctx.textBaseline = "bottom";
      ctx.shadowColor = "rgb(0,0,0)";
      ctx.shadowOffsetX = 1;
      ctx.shadowOffsetY = 1;
      ctx.shadowBlur = 2;
      ctx.fillText(titleText, 400, titleY);
      ctx.shadowColor = "transparent";

      // Dibuja los códigos QR
      if (isTruckersmpValid) {
        const qr = new QRious({ value: truckersmpLink, size: config.qrSize, level: 'H' });
        const qrCanvas = document.createElement("canvas");
        qrCanvas.width = config.qrSize;
        qrCanvas.height = config.qrSize;
        qrCanvas.getContext("2d").drawImage(qr.canvas, 0, 0);
        ctx.drawImage(qrCanvas, config.qrX, config.qrY, config.qrSize, config.qrSize);
        if (idImg) ctx.drawImage(idImg, config.qrX + config.qrSize + config.qrSpacing, config.qrY, config.qrSize, config.qrSize);
      }
      if (isCompanyValid) {
        const qrCompany = new QRious({ value: companyLink, size: config.qrSize, level: 'H' });
        const qrCompanyCanvas = document.createElement("canvas");
        qrCompanyCanvas.width = config.qrSize;
        qrCompanyCanvas.height = config.qrSize;
        qrCompanyCanvas.getContext("2d").drawImage(qrCompany.canvas, 0, 0);
        ctx.drawImage(qrCompanyCanvas, config.qrX - config.qrSize - config.qrSpacing, config.qrY, config.qrSize, config.qrSize);
      }

      ctx.restore();
      try {
        updateDownloadLink();
      } catch (error) {
        console.error("Error generating download link:", error);
      }
    }

    // Actualiza el enlace de descarga de la imagen
    function updateDownloadLink() {
      const downloadLink = document.getElementById("descargar");
      const name = nameInput.value || "unknown";
      try {
        downloadLink.href = canvas.toDataURL("image/png");
        downloadLink.download = `driver_license_${name}.png`;
      } catch (error) {
        downloadLink.href = "#";
        downloadLink.download = "";
        console.error("Error in toDataURL:", error);
      }
    }

    // Maneja el cambio de la imagen subida por el usuario
    photoInput.addEventListener("change", event => {
      const file = event.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = ev => {
          userImage = new Image();
          userImage.src = ev.target.result;
          userImage.crossOrigin = "anonymous";
          userImage.onload = debouncedGenerateImage;
        };
        reader.readAsDataURL(file);
      } else {
        userImage = null;
        debouncedGenerateImage();
      }
    });

    // Maneja la validación del enlace de TruckersMP
    truckersmpLinkInput.addEventListener("input", () => {
      const link = truckersmpLinkInput.value.trim();
      if (link) {
        validateTruckersmpLink(link);
      } else {
        truckersmpStatus.textContent = "";
        truckersmpStatus.className = "";
      }
      debouncedGenerateImage();
    });

    // Maneja la validación del enlace de la empresa
    companyLinkInput.addEventListener("input", () => {
      const link = companyLinkInput.value.trim();
      if (link) {
        validateCompanyLink(link);
      } else {
        companyLinkStatus.textContent = "";
        companyLinkStatus.className = "";
      }
      debouncedGenerateImage();
    });

    // Maneja el cambio de idioma
    languageSelect.addEventListener("change", () => updateLanguage(languageSelect.value));

    // Actualiza el valor del slider de color
    colorSlider.addEventListener("input", () => {
      colorValue.textContent = `${colorSlider.value}°`;
      debouncedGenerateImage();
    });

    // Versión debounced de generateImage para evitar redibujar demasiado rápido
    const debouncedGenerateImage = debounce(generateImage, 200);

    // Asocia eventos a los inputs
    nameInput.addEventListener("input", updateForm);
    countrySelect.addEventListener("change", () => {
      saveDefaultCountry();
      debouncedGenerateImage();
    });
    nicknameSelect.addEventListener("change", debouncedGenerateImage);
    titleToggleInput.addEventListener("change", debouncedGenerateImage);
    promodsToggleInput.addEventListener("change", debouncedGenerateImage);
    dbusworldToggleInput.addEventListener("change", debouncedGenerateImage);
    customTitleInput.addEventListener("input", debouncedGenerateImage);

    // Inicializa la página
    loadDefaultCountry();
    updateForm();
    updateLanguage(currentLanguage);
    debouncedGenerateImage();
  </script>
</body>
</html>
