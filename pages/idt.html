<!DOCTYPE html>
<html lang="es">
<head>
  <!-- Definición de la codificación y compatibilidad -->
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Título de la página, actualizado dinámicamente según el idioma -->
  <title id="pageTitle">Convoyrama | Generador de Licencia</title>
  <meta name="description" content="Convoyrama">

  <!-- Recursos externos y estilos -->
  <link rel="stylesheet" href="../assets/style.css">
  <link rel="icon" href="../assets/images/favicon.png">
  <link rel="apple-touch-icon" href="../assets/images/favicon.png">

  <!-- Librería QRious para generar códigos QR -->
  <script src="https://cdn.jsdelivr.net/npm/qrious@4.0.2/dist/qrious.min.js"></script>

  <!-- Librería Twemoji para renderizar emojis en formato SVG -->
  <script src="https://twemoji.maxcdn.com/v/latest/twemoji.min.js" crossorigin="anonymous"></script>

  <!-- Estilos CSS embebidos -->
  <style>
    /* Fuentes personalizadas (Verdana) */
    @font-face { font-family: 'Verdana'; src: url('./verdana/Verdana.ttf') format('truetype'); font-weight: 400; font-style: normal; }
    @font-face { font-family: 'Verdana-Bold'; src: url('./verdana/Verdana-Bold.ttf') format('truetype'); font-weight: 700; font-style: normal; }
    @font-face { font-family: 'Verdana-Italic'; src: url('./verdana/Verdana-Italic.ttf') format('truetype'); font-weight: 400; font-style: italic; }
    @font-face { font-family: 'Verdana-BoldItalic'; src: url('./verdana/Verdana-BoldItalic.ttf') format('truetype'); font-weight: 700; font-style: italic; }

    /* Estilos para el header */
    header { padding: 15px; text-align: center; position: relative; z-index: 10; background: var(--accent-bg); border-bottom: 1px solid var(--border); }
    header p { font-size: 1.2em; text-shadow: none; font-family: Arial, sans-serif; font-weight: normal; margin: 10px 0; color: #fff; }

    /* Estilos para la navegación */
    nav { padding: 10px; text-align: center; }
    nav a, nav a:visited { text-decoration: none; margin: 0 15px; font-size: 1em; text-shadow: none; color: #fff; }
    nav a:hover { text-decoration: underline; }

    /* Contenedor principal con flexbox para el panel y el canvas */
    .contenedor { display: flex; gap: 15px; padding: 15px; align-items: flex-start; font-family: Arial, sans-serif; }

    /* Estilos para el panel de inputs */
    .panel { flex: 1; max-width: 250px; font-size: 13px; }
    .panel h3 { margin: 10px 0 5px; font-size: 13px; }

    /* Estilos para los grupos de inputs */
    .input-group { margin: 5px 0; }
    .input-group input,
    .input-group select { width: 230px; box-sizing: border-box; padding: 8px; font-size: 13px; border: 1px solid #ccc; border-radius: 4px; }
    input[type="file"] { width: 230px; box-sizing: border-box; font-size: 13px; border: none; padding: 8px 0; }

    /* Estilos para los toggles */
    .toggle-item { margin: 5px 0; }
    .toggle-item input[type="checkbox"] { margin-right: 5px; }

    /* Estilos para el canvas */
    canvas { border: 1px solid #000; display: block; max-width: 100%; height: auto; }

    /* Estilos para la sección de previsualización */
    #preview { flex: 1; text-align: center; }

    /* Estilos para los botones */
    button { padding: 5px 10px; font-size: 13px; margin-top: 8px; background: rgb(90,165,25); color: #fff; border: none; border-radius: 6px; cursor: pointer; }
    button:hover { opacity: 0.8; }

    /* Tooltip para el botón de descargar */
    button.info-tooltip:hover::after {
      content: attr(data-tooltip);
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      background: #333;
      color: #fff;
      padding: 5px 10px;
      border-radius: 4px;
      font-size: 12px;
      white-space: nowrap;
      z-index: 10;
    }

    /* Clase para ocultar elementos */
    .hidden { display: none; }

    /* Estilos para los mensajes de estado de los enlaces */
    #truckersmpStatus, #empresaLinkStatus { font-size: 11px; color: #555; margin-top: 5px; }
    .valid { color: green; }
    .invalid { color: red; }

    /* Estilos para el slider de color */
    #colorSlider { width: 80%; margin-top: 5px; vertical-align: middle; }
    #colorValue { display: inline-block; width: 15%; text-align: right; font-size: 13px; color: #555; }

    /* Estilos para el footer */
    footer { margin: 8px 0; }
  </style>
</head>
<body>
  <!-- Encabezado con navegación -->
  <header>
    <nav>
      <a href="../index.html">Home</a>
      <a href="pc.html">Creador de Perfil</a>
      <a href="id.html" id="navLicense">Licencia</a>
    </nav>
    <p id="headerTitle">Generador de Licencia de Conductor</p>
  </header>

  <!-- Contenedor principal con panel de inputs y previsualización -->
  <div class="contenedor">
    <!-- Panel de inputs -->
    <div class="panel">
      <!-- Selección de idioma -->
      <div class="input-group">
        <label for="languageToggle">Idioma / Language / Língua:</label><br>
        <select id="languageToggle">
          <option value="es">Español</option>
          <option value="en">English</option>
          <option value="pt">Português</option>
        </select>
      </div>

      <!-- Slider para el tono del fondo -->
      <div class="input-group">
        <label for="colorSlider" id="colorLabel">Tono del fondo:</label><br>
        <input type="range" id="colorSlider" min="0" max="360" value="0">
        <span id="colorValue">0°</span>
      </div>

      <!-- Campo para el nombre -->
      <div class="input-group">
        <label for="nombre" id="nameLabel">Nombre:</label><br>
        <input type="text" id="nombre" placeholder="Nombre / Name / Nome" required>
      </div>

      <!-- Campo para el TAG épico, oculto inicialmente -->
      <div class="input-group hidden" id="nicknameGroup">
        <label for="nickname" id="nicknameLabel">TAG Épico:</label><br>
        <select id="nickname">
          <option value="">Seleccione un TAG</option>
          <option value="ReyDelLag">ReyDelLag</option>
          <option value="FrenadorEnCurva">FrenadorEnCurva</option>
          <option value="SeñorDelLagazo">SeñorDelLagazo</option>
          <option value="BocinaLoca">BocinaLoca</option>
          <option value="CargadorDeDeudas">CargadorDeDeudas</option>
          <option value="CamioneroDelApagón">CamioneroDelApagón</option>
          <option value="FugitivoDeLaRuta">FugitivoDeLaRuta</option>
          <option value="MaestroDelPing">MaestroDelPing</option>
          <option value="ReyDeLaCarretera">ReyDeLaCarretera</option>
          <option value="LocoDelVolante">LocoDelVolante</option>
          <option value="SobrevivienteDelBan">SobrevivienteDelBan</option>
          <option value="BanEvasor">BanEvasor</option>
          <option value="FrenazoEstelar">FrenazoEstelar</option>
          <option value="TerrorDeCalais">TerrorDeCalais</option>
          <option value="LagLegendario">LagLegendario</option>
          <option value="SobrevivienteDeKirkenes">SobrevivienteDeKirkenes</option>
          <option value="MaestroDelReckless">MaestroDelReckless</option>
          <option value="PingParalizante">PingParalizante</option>
          <option value="RutaSinRetorno">RutaSinRetorno</option>
          <option value="VolanteEndemoniado">VolanteEndemoniado</option>
          <option value="AsDelReporte">AsDelReporte</option>
          <option value="ReyDeDuisburg">ReyDeDuisburg</option>
          <option value="ReyDeCalais">ReyDeCalais</option>
          <option value="KaosEnLaRuta">KaosEnLaRuta</option>
          <option value="CarreteraPerdida">CarreteraPerdida</option>
          <option value="FrenadorDePánico">FrenadorDePánico</option>
          <option value="CargaConDrama">CargaConDrama</option>
        </select>
      </div>

      <!-- Campo para subir una foto -->
      <div class="input-group">
        <label for="foto" id="photoLabel">Foto (Opcional):</label><br>
        <input type="file" id="foto" accept="image/*">
      </div>

      <!-- Selección de país (solo países latinoamericanos) -->
      <div class="input-group">
        <label for="pais" id="countryLabel">País:</label><br>
        <select id="pais" required>
          <option value="">Seleccione un país / Select a country / Selecione um país</option>
          <option value="AR|🇦🇷|Argentina|Argentina|Argentina">🇦🇷 Argentina</option>
          <option value="BO|🇧🇴|Bolivia|Bolivia|Bolívia">🇧🇴 Bolivia</option>
          <option value="BR|🇧🇷|Brasil|Brazil|Brasil">🇧🇷 Brasil</option>
          <option value="CL|🇨🇱|Chile|Chile|Chile">🇨🇱 Chile</option>
          <option value="CO|🇨🇴|Colombia|Colombia|Colômbia">🇨🇴 Colombia</option>
          <option value="CR|🇨🇷|Costa Rica|Costa Rica|Costa Rica">🇨🇷 Costa Rica</option>
          <option value="CU|🇨🇺|Cuba|Cuba|Cuba">🇨🇺 Cuba</option>
          <option value="EC|🇪🇨|Ecuador|Ecuador|Equador">🇪🇨 Ecuador</option>
          <option value="SV|🇸🇻|El Salvador|El Salvador|El Salvador">🇸🇻 El Salvador</option>
          <option value="GT|🇬🇹|Guatemala|Guatemala|Guatemala">🇬🇹 Guatemala</option>
          <option value="HN|🇭🇳|Honduras|Honduras|Honduras">🇭🇳 Honduras</option>
          <option value="MX|🇲🇽|México|Mexico|México">🇲🇽 México</option>
          <option value="NI|🇳🇮|Nicaragua|Nicaragua|Nicarágua">🇳🇮 Nicaragua</option>
          <option value="PA|🇵🇦|Panamá|Panama|Panamá">🇵🇦 Panamá</option>
          <option value="PY|🇵🇾|Paraguay|Paraguay|Paraguai">🇵🇾 Paraguay</option>
          <option value="PE|🇵🇪|Perú|Peru|Peru">🇵🇪 Perú</option>
          <option value="PR|🇵🇷|Puerto Rico|Puerto Rico|Porto Rico">🇵🇷 Puerto Rico</option>
          <option value="DO|🇩🇴|República Dominicana|Dominican Republic|República Dominicana">🇩🇴 República Dominicana</option>
          <option value="UY|🇺🇾|Uruguay|Uruguay|Uruguai">🇺🇾 Uruguay</option>
          <option value="VE|🇻🇪|Venezuela|Venezuela|Venezuela">🇻🇪 Venezuela</option>
        </select>
      </div>

      <!-- Campo para el enlace de la empresa en TruckersMP -->
      <div class="input-group">
        <label for="empresaLink" id="companyLinkLabel">Enlace Perfil Empresa en TMP:</label><br>
        <input type="text" id="empresaLink" placeholder="TruckersMP Company Profile Link" required>
        <div id="empresaLinkStatus"></div>
      </div>

      <!-- Campo para el enlace del perfil en TruckersMP -->
      <div class="input-group">
        <label for="truckersmpLink" id="truckersmpLinkLabel">Enlace Perfil en TMP:</label><br>
        <input type="text" id="truckersmpLink" placeholder="TruckersMP Profile Link" required>
        <div id="truckersmpStatus"></div>
      </div>

      <!-- Campo para el título personalizado -->
      <div class="input-group">
        <label for="customTitle" id="customTitleLabel">Cambiar título:</label><br>
        <input type="text" id="customTitle" maxlength="36" placeholder="Título personalizado (máx. 36 caracteres, opcional)">
      </div>

      <!-- Toggle para ProMods -->
      <div class="toggle-item">
        <label for="promodsToggle">ProMods:</label><br>
        <input type="checkbox" id="promodsToggle">
      </div>

      <!-- Toggle para DBus -->
      <div class="toggle-item">
        <label for="dbusworldToggle">DBUS:</label><br>
        <input type="checkbox" id="dbusworldToggle">
      </div>

      <!-- Toggle para usar texto alternativo -->
      <div class="toggle-item">
        <label for="altTextToggle" id="altTextToggleLabel">Usar texto alternativo:</label><br>
        <input type="checkbox" id="altTextToggle">
      </div>

      <!-- Toggle para usar el logo de VTC, oculto inicialmente -->
      <div class="toggle-item hidden" id="vtcLogoToggleGroup">
        <label for="vtcLogoToggle" id="vtcLogoToggleLabel">Usar logo de VTC:</label><br>
        <input type="checkbox" id="vtcLogoToggle">
      </div>
    </div>

    <!-- Sección de previsualización con el canvas -->
    <div id="preview">
      <canvas id="canvas" width="800" height="500"></canvas>
      <br>
      <a id="descargar" download="driver_license.png">
        <button id="botonDescargar" class="info-tooltip" data-tooltip="Esta licencia es una broma y un guiño a la comunidad, no pretende ser profesional ni seria.">Descargar Licencia</button>
      </a>
    </div>
  </div>

  <!-- Footer -->
  <footer><small>© LAG'S SPEED - CONVOYRAMA 2025 - v1.0</small></footer>

  <!-- Código JavaScript -->
  <script>
    // Función para cargar emojis como imágenes SVG usando Twemoji
    function renderTwemoji(emoji, size) {
      return new Promise(resolve => {
        const image = new Image();
        image.crossOrigin = "anonymous";
        image.onload = () => resolve(image);
        image.src = twemoji.parse(emoji, { folder: 'svg', ext: '.svg' }).match(/src="([^"]+)"/)?.[1] || "";
      });
    }

    // Configuración de coordenadas y tamaños para los elementos del canvas
    const config = {
      color: "white",
      flagSize: 80,
      photoX: 45,
      photoY: 80,
      labelX: 100,
      colonX: 130,
      textX: 295,
      textY: 334,
      qrX: 573,
      qrY: 101,
      flagX: 625,
      flagY: 206,
      vtcLogoX: 625 - 50,
      vtcLogoY: 206 + 40,
      font: "'Verdana', sans-serif",
      defaultPhotoSize: 192,
      qrSize: 100,
      qrSpacing: 10,
      promodsX: 20,
      promodsY: 334,
      dbusworldX: 20,
      dbusworldY: 394,
      logoWidth: 67,
      logoHeight: 50,
      vtcLogoSize: 100
    };

    // Mapeo de enlaces de VTC a nombres de archivos de logos
    const vtcMap = {
      "https://truckersmp.com/vtc/78865": "ls.png",
      "https://truckersmp.com/vtc/76978": "tcs.png",
      "https://truckersmp.com/vtc/55250-andesvtc": "andes.png",
      "https://truckersmp.com/vtc/55250": "andes.png",
      "https://truckersmp.com/vtc/29591": "castores.jpg",
      "https://truckersmp.com/vtc/81636": "chapu.jpeg",
      "https://truckersmp.com/vtc/55439-destiny": "destiny.png",
      "https://truckersmp.com/vtc/55439": "destiny.png",
      "https://truckersmp.com/vtc/56572-lsavtc": "lsa.png",
      "https://truckersmp.com/vtc/56572": "lsa.png",
      "https://truckersmp.com/vtc/79357": "norte.png",
      "https://truckersmp.com/vtc/34966-nova-era": "nova.png",
      "https://truckersmp.com/vtc/34966": "nova.png",
      "https://truckersmp.com/vtc/64312": "shipeados.png",
      "https://truckersmp.com/vtc/65011": "tl.png",
      "https://truckersmp.com/vtc/17910-transportesatr": "atr.png",
      "https://truckersmp.com/vtc/17910": "atr.png",
      "https://truckersmp.com/vtc/63758": "cord.jpg",
      "https://truckersmp.com/vtc/48970": "sin.jpg",
      "https://truckersmp.com/vtc/70703": "as.png",
      "https://truckersmp.com/vtc/77802": "ex.png",
      "https://truckersmp.com/vtc/62448": "rut.jpg",
      "https://truckersmp.com/vtc/11715": "avant.png",
      "https://truckersmp.com/vtc/76975": "titan.png",
      "https://truckersmp.com/vtc/3414": "baltico.png",
      "https://truckersmp.com/vtc/79130": "corr.png",
      "https://truckersmp.com/vtc/74222": "esp.jpg",
      "https://truckersmp.com/vtc/63303": "coo.png",
      "https://truckersmp.com/vtc/1271": "ali.png",
      "https://truckersmp.com/vtc/50578": "tcc.png",
      "https://truckersmp.com/vtc/56350": "gaat.png",
      "https://truckersmp.com/vtc/2436": "go.png"
    };

    // Traducciones para los textos en diferentes idiomas
    const translations = {
      es: {
        pageTitle: "Convoyrama | Generador de Licencia",
        headerTitle: "Generador de Licencia de Conductor",
        navLicense: "Licencia",
        nameLabel: "Nombre:",
        nicknameLabel: "TAG Épico:",
        altTextToggleLabel: "Usar texto alternativo:",
        vtcLogoToggleLabel: "Usar logo de VTC:",
        photoLabel: "Foto (Opcional):",
        countryLabel: "País:",
        companyLinkLabel: "Enlace Perfil Empresa en TMP:",
        truckersmpLinkLabel: "Enlace Perfil en TMP:",
        customTitleLabel: "Cambiar título:",
        customTitlePlaceholder: "Título personalizado (máx. 36 caracteres, opcional)",
        validLink: "Enlace válido",
        invalidLink: "Enlace inválido: debe ser https://truckersmp.com/user/[...]",
        validCompanyLink: "Enlace de empresa válido",
        invalidCompanyLink: "Enlace inválido: debe ser https://truckersmp.com/vtc/[...]",
        downloadButton: "Descargar Licencia",
        canvasName: "Nombre :",
        canvasLicenseNo: "Núm. Licencia :",
        canvasDate: "Fecha :",
        canvasCountry: "País :",
        canvasTag: "TAG :",
        titleNormal: "PERMISO DE CONDUCCIÓN INTERNACIONAL",
        titleComedic: "PERMISO PARA CHOCAR EN CONVOY",
        countryPlaceholder: "Seleccione un país",
        colorLabel: "Tono del fondo:",
        tooltipMessage: "Esta licencia es una broma y un guiño a la comunidad, no pretende ser profesional ni seria."
      },
      en: {
        pageTitle: "Convoyrama | Driver License Generator",
        headerTitle: "Driver License Generator",
        navLicense: "License",
        nameLabel: "Name:",
        nicknameLabel: "Epic TAG:",
        altTextToggleLabel: "Use alternative text:",
        vtcLogoToggleLabel: "Use VTC logo:",
        photoLabel: "Photo (Optional):",
        countryLabel: "Country:",
        companyLinkLabel: "TruckersMP Company Profile Link:",
        truckersmpLinkLabel: "TruckersMP Profile Link:",
        customTitleLabel: "Change title:",
        customTitlePlaceholder: "Custom title (max 36 characters, optional)",
        validLink: "Valid link",
        invalidLink: "Invalid link: must be https://truckersmp.com/user/[...]",
        validCompanyLink: "Valid company link",
        invalidCompanyLink: "Invalid link: must be https://truckersmp.com/vtc/[...]",
        downloadButton: "Download License",
        canvasName: "Name :",
        canvasLicenseNo: "License No. :",
        canvasDate: "Date :",
        canvasCountry: "Country :",
        canvasTag: "TAG :",
        titleNormal: "INTERNATIONAL DRIVING LICENSE",
        titleComedic: "CONVOY CRASHING PERMIT",
        countryPlaceholder: "Select a country",
        colorLabel: "Background hue:",
        tooltipMessage: "This license is a joke and a nod to the community, not intended to be professional or serious."
      },
      pt: {
        pageTitle: "Convoyrama | Gerador de Licença",
        headerTitle: "Gerador de Licença de Motorista",
        navLicense: "Licença",
        nameLabel: "Nome:",
        nicknameLabel: "TAG Épico:",
        altTextToggleLabel: "Usar texto alternativo:",
        vtcLogoToggleLabel: "Usar logo da VTC:",
        photoLabel: "Foto (Opcional):",
        countryLabel: "País:",
        companyLinkLabel: "Link do Perfil da Empresa no TruckersMP:",
        truckersmpLinkLabel: "Link do Perfil no TruckersMP:",
        customTitleLabel: "Alterar título:",
        customTitlePlaceholder: "Título personalizado (máx. 36 caracteres, opcional)",
        validLink: "Link válido",
        invalidLink: "Link inválido: deve ser https://truckersmp.com/user/[...]",
        validCompanyLink: "Link de empresa válido",
        invalidCompanyLink: "Link inválido: deve ser https://truckersmp.com/vtc/[...]",
        downloadButton: "Baixar Licença",
        canvasName: "Nome :",
        canvasLicenseNo: "Nº da Licença :",
        canvasDate: "Data :",
        canvasCountry: "País :",
        canvasTag: "TAG :",
        titleNormal: "LICENÇA INTERNACIONAL DE CONDUÇÃO",
        titleComedic: "PERMISSÃO PARA CAUSAR CAOS EM COMBOIO",
        countryPlaceholder: "Selecione um país",
        colorLabel: "Tom do fundo:",
        tooltipMessage: "Esta licença é uma brincadeira e uma homenagem à comunidade, não pretende ser profissional ou séria."
      }
    };

    // Referencias a los elementos del DOM
    const canvas = document.getElementById("canvas");
    const context = canvas.getContext("2d");
    const nameInput = document.getElementById("nombre");
    const photoInput = document.getElementById("foto");
    const countryInput = document.getElementById("pais");
    const nicknameInput = document.getElementById("nickname");
    const companyLinkInput = document.getElementById("empresaLink");
    const truckersmpLinkInput = document.getElementById("truckersmpLink");
    const truckersmpStatus = document.getElementById("truckersmpStatus");
    const companyLinkStatus = document.getElementById("empresaLinkStatus");
    const nicknameGroup = document.getElementById("nicknameGroup");
    const altTextToggleInput = document.getElementById("altTextToggle");
    const promodsToggleInput = document.getElementById("promodsToggle");
    const dbusworldToggleInput = document.getElementById("dbusworldToggle");
    const vtcLogoToggleInput = document.getElementById("vtcLogoToggle");
    const vtcLogoToggleGroup = document.getElementById("vtcLogoToggleGroup");
    const languageToggle = document.getElementById("languageToggle");
    const colorSlider = document.getElementById("colorSlider");
    const colorValue = document.getElementById("colorValue");
    const downloadButton = document.getElementById("botonDescargar");
    const customTitleInput = document.getElementById("customTitle");

    // Variables globales
    let userImage = null;
    let isNicknameUnlocked = localStorage.getItem("nicknameUnlocked") === "true";
    let cachedDate = null;
    let lastDateFetch = 0;
    const DATE_CACHE_DURATION = 180000;
    let currentLanguage = "es";

    // Función para obtener la fecha actual desde APIs externas o localmente
    async function getDate() {
      const now = Date.now();
      if (cachedDate && now - lastDateFetch < DATE_CACHE_DURATION) {
        return cachedDate;
      }

      const apis = [
        {
          url: 'https://worldtimeapi.org/api/timezone/Etc/UTC',
          parse: data => {
            const dateTime = new Date(data.datetime);
            return {
              day: dateTime.getDate().toString().padStart(2, "0"),
              month: (dateTime.getMonth() + 1).toString().padStart(2, "0"),
              year: dateTime.getFullYear()
            };
          }
        },
        {
          url: 'https://timeapi.io/api/Time/current/utc',
          parse: data => ({
            day: data.day.toString().padStart(2, "0"),
            month: data.month.toString().padStart(2, "0"),
            year: data.year
          })
        },
        {
          url: 'https://worldclockapi.herokuapp.com/api/json/utc/now',
          parse: data => {
            const dateTime = new Date(data.currentDateTime);
            return {
              day: dateTime.getDate().toString().padStart(2, "0"),
              month: (dateTime.getMonth() + 1).toString().padStart(2, "0"),
              year: dateTime.getFullYear()
            };
          }
        }
      ];

      for (const api of apis) {
        try {
          const response = await fetch(api.url);
          const data = await response.json();
          const { day, month, year } = api.parse(data);
          cachedDate = `${day}/${month}/${year}`;
          lastDateFetch = now;
          return cachedDate;
        } catch (error) {}
      }

      const date = new Date();
      cachedDate = `${date.getDate().toString().padStart(2, "0")}/${(date.getMonth() + 1).toString().padStart(2, "0")}/${date.getFullYear()}`;
      lastDateFetch = now;
      return cachedDate;
    }

    // Función para actualizar los textos de la interfaz según el idioma seleccionado
    function updateLanguage(language) {
      currentLanguage = language;
      const translation = translations[language];
      document.getElementById("pageTitle").textContent = translation.pageTitle;
      document.getElementById("headerTitle").textContent = translation.headerTitle;
      document.getElementById("navLicense").textContent = translation.navLicense;
      document.getElementById("nameLabel").textContent = translation.nameLabel;
      document.getElementById("nicknameLabel").textContent = translation.nicknameLabel;
      document.getElementById("altTextToggleLabel").textContent = translation.altTextToggleLabel;
      document.getElementById("vtcLogoToggleLabel").textContent = translation.vtcLogoToggleLabel;
      document.getElementById("photoLabel").textContent = translation.photoLabel;
      document.getElementById("countryLabel").textContent = translation.countryLabel;
      document.getElementById("companyLinkLabel").textContent = translation.companyLinkLabel;
      document.getElementById("truckersmpLinkLabel").textContent = translation.truckersmpLinkLabel;
      document.getElementById("customTitleLabel").textContent = translation.customTitleLabel;
      document.getElementById("botonDescargar").textContent = translation.downloadButton;
      document.getElementById("botonDescargar").setAttribute("data-tooltip", translation.tooltipMessage);
      countryInput.options[0].text = translation.countryPlaceholder;
      customTitleInput.placeholder = translation.customTitlePlaceholder;

      const truckersmpLink = truckersmpLinkInput.value.trim();
      const companyLink = companyLinkInput.value.trim();
      if (truckersmpLink) validateTruckersmpLink(truckersmpLink);
      if (companyLink) validateCompanyLink(companyLink);
      debouncedGenerateImage();
    }

    // Función para generar el número de licencia
    function generateLicenseNumber(name, country, truckersmpLink) {
      const countryCode = country.split("|")[0].substring(0, 2) || "XX";
      let userId = "";
      if (truckersmpLink) {
        const match = truckersmpLink.match(/truckersmp\.com\/user\/(.+)/);
        userId = match ? match[1] : "";
      }
      return userId ? `${countryCode}${userId}` : "";
    }

    // Función para validar el enlace de TruckersMP
    function validateTruckersmpLink(link) {
      const regex = /^https:\/\/truckersmp\.com\/user\/.+$/;
      const translation = translations[currentLanguage];
      if (!regex.test(link)) {
        truckersmpStatus.textContent = translation.invalidLink;
        truckersmpStatus.className = "invalid";
        return false;
      }
      truckersmpStatus.textContent = translation.validLink;
      truckersmpStatus.className = "valid";
      return true;
    }

    // Función para validar el enlace de la empresa
    function validateCompanyLink(link) {
      const regex = /^https:\/\/truckersmp\.com\/vtc\/.+$/;
      const translation = translations[currentLanguage];
      if (!regex.test(link)) {
        companyLinkStatus.textContent = translation.invalidCompanyLink;
        companyLinkStatus.className = "invalid";
        return false;
      }
      companyLinkStatus.textContent = translation.validCompanyLink;
      companyLinkStatus.className = "valid";
      return true;
    }

    // Función para implementar debounce
    function debounce(func, wait) {
      let timeout;
      return function (...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }

    // Función para guardar el país seleccionado en localStorage
    function saveDefaultCountry() {
      localStorage.setItem("defaultCountry", countryInput.value);
    }

    // Función para cargar el país guardado desde localStorage
    function loadDefaultCountry() {
      const savedCountry = localStorage.getItem("defaultCountry");
      if (savedCountry) {
        countryInput.value = savedCountry;
      }
    }

    // Función para manejar cambios en los inputs y actualizar la interfaz
    function updateForm() {
      const name = nameInput.value.toLowerCase().trim();
      if (name === "resetnick") {
        isNicknameUnlocked = false;
        localStorage.removeItem("nicknameUnlocked");
      } else if (["convoyrama", "nocturnoverso"].includes(name)) {
        isNicknameUnlocked = true;
        localStorage.setItem("nicknameUnlocked", "true");
      }
      nicknameGroup.classList.toggle("hidden", !isNicknameUnlocked);

      const companyLink = companyLinkInput.value.trim();
      const colorMap = {
        "https://truckersmp.com/vtc/78865": 260,
        "https://truckersmp.com/vtc/76978": 200
      };
      const newColor = colorMap[companyLink] || colorSlider.value;
      colorSlider.value = newColor;
      colorValue.textContent = `${newColor}°`;

      if (companyLink) validateCompanyLink(companyLink);
      vtcLogoToggleGroup.classList.toggle("hidden", !vtcMap[companyLink]);
      debouncedGenerateImage();
    }

    // Estado anterior del formulario
    let lastFormState = {};

    // Función para obtener el estado actual del formulario
    function getFormState() {
      return {
        name: nameInput.value,
        country: countryInput.value,
        nickname: nicknameInput.value,
        truckersmpLink: truckersmpLinkInput.value,
        companyLink: companyLinkInput.value,
        altTextToggle: altTextToggleInput.checked,
        promodsToggle: promodsToggleInput.checked,
        dbusworldToggle: dbusworldToggleInput.checked,
        vtcLogoToggle: vtcLogoToggleInput.checked,
        userImage: userImage ? userImage.src : null,
        language: currentLanguage,
        colorHue: colorSlider.value,
        customTitle: customTitleInput.value
      };
    }

    // Función para cargar una imagen
    function loadImage(src) {
      return new Promise((resolve, reject) => {
        const img = new Image();
        img.crossOrigin = "anonymous";
        img.onload = () => resolve(img);
        img.onerror = reject;
        img.src = src;
      });
    }

    // Función principal para generar la imagen del canvas
    async function generateImage() {
      const formState = getFormState();
      if (JSON.stringify(formState) === JSON.stringify(lastFormState)) {
        return;
      }
      lastFormState = formState;

      const translation = translations[currentLanguage];
      const name = nameInput.value || (currentLanguage === "es" ? "Sin nombre" : currentLanguage === "en" ? "No name" : "Sem nome");
      const countryData = countryInput.value.split("|");
      const countryCode = countryData[0] || "XX";
      const flag = countryData[1] || "";
      const countryName = countryData[currentLanguage === "es" ? 2 : currentLanguage === "en" ? 3 : 4] || (currentLanguage === "es" ? "Sin país" : currentLanguage === "en" ? "No country" : "Sem país");
      const nickname = nicknameInput.value || "";
      const truckersmpLink = truckersmpLinkInput.value.trim();
      const companyLink = companyLinkInput.value.trim();
      const isTruckersmpValid = truckersmpLink ? validateTruckersmpLink(truckersmpLink) : false;
      const isCompanyValid = companyLink ? validateCompanyLink(companyLink) : false;
      const hueRotate = parseInt(colorSlider.value);
      const customTitle = customTitleInput.value.trim();
      const date = await getDate();

      context.clearRect(0, 0, canvas.width, canvas.height);

      // Carga la imagen de fondo
      try {
        const backgroundImage = await loadImage("../assets/images/id.jpg");
        context.filter = `hue-rotate(${hueRotate}deg)`;
        context.drawImage(backgroundImage, 0, 0, canvas.width, canvas.height);
        context.filter = "none";
      } catch (error) {
        console.error("Error cargando la imagen de fondo:", error);
      }

      // Dibuja la foto del usuario
      if (userImage) {
        context.save();
        context.beginPath();
        context.arc(config.photoX + config.defaultPhotoSize / 2, config.photoY + config.defaultPhotoSize / 2, config.defaultPhotoSize / 2, 0, Math.PI * 2);
        context.clip();
        context.drawImage(userImage, config.photoX, config.photoY, config.defaultPhotoSize, config.defaultPhotoSize);
        context.restore();
      }

      // Configura la fuente para los textos
      context.font = `14px ${config.font}`;
      context.fillStyle = config.color;

      // Dibuja los textos de las etiquetas
      context.fillText(translation.canvasName, config.labelX, config.textY);
      context.fillText(translation.canvasLicenseNo, config.labelX, config.textY + 20);
      context.fillText(translation.canvasDate, config.labelX, config.textY + 40);
      context.fillText(translation.canvasCountry, config.labelX, config.textY + 60);
      if (isNicknameUnlocked && nickname) {
        context.fillText(translation.canvasTag, config.labelX, config.textY + 80);
      }

      // Dibuja los dos puntos
      context.fillText(":", config.colonX, config.textY);
      context.fillText(":", config.colonX, config.textY + 20);
      context.fillText(":", config.colonX, config.textY + 40);
      context.fillText(":", config.colonX, config.textY + 60);
      if (isNicknameUnlocked && nickname) {
        context.fillText(":", config.colonX, config.textY + 80);
      }

      // Dibuja los valores de los campos
      context.fillText(name.substring(0, 20), config.textX, config.textY);
      context.fillText(generateLicenseNumber(name, countryInput.value, truckersmpLink), config.textX, config.textY + 20);
      context.fillText(date, config.textX, config.textY + 40);
      context.fillText(countryName, config.textX, config.textY + 60);
      if (isNicknameUnlocked && nickname) {
        context.fillText(nickname, config.textX, config.textY + 80);
      }

      // Dibuja la bandera
      if (flag) {
        const flagImage = await renderTwemoji(flag, config.flagSize);
        context.drawImage(flagImage, config.flagX, config.flagY, config.flagSize, config.flagSize);
      }

      // Dibuja los códigos QR
      if (isTruckersmpValid) {
        const qr = new QRious({
          value: truckersmpLink,
          size: config.qrSize,
          level: "M"
        });
        const qrImage = await loadImage(qr.toDataURL());
        context.drawImage(qrImage, config.qrX, config.qrY);
      }

      if (isCompanyValid) {
        const qr = new QRious({
          value: companyLink,
          size: config.qrSize,
          level: "M"
        });
        const qrImage = await loadImage(qr.toDataURL());
        context.drawImage(qrImage, config.qrX, config.qrY + config.qrSize + config.qrSpacing);
      }

      // Dibuja el logo de ProMods
      if (promodsToggleInput.checked) {
        try {
          const promodsImage = await loadImage("../assets/images/promods.png");
          context.drawImage(promodsImage, config.promodsX, config.promodsY, config.logoWidth, config.logoHeight);
        } catch (error) {
          console.error("Error cargando el logo de ProMods:", error);
        }
      }

      // Dibuja el logo de DBus
      if (dbusworldToggleInput.checked) {
        try {
          const dbusworldImage = await loadImage("../assets/images/dbus.png");
          context.drawImage(dbusworldImage, config.dbusworldX, config.dbusworldY, config.logoWidth, config.logoHeight);
        } catch (error) {
          console.error("Error cargando el logo de DBus:", error);
        }
      }

      // Dibuja el logo de VTC
      if (vtcLogoToggleInput.checked && vtcMap[companyLink]) {
        try {
          const vtcLogoImage = await loadImage(`../assets/images/${vtcMap[companyLink]}`);
          context.drawImage(vtcLogoImage, config.vtcLogoX, config.vtcLogoY, config.vtcLogoSize, config.vtcLogoSize);
        } catch (error) {
          console.error("Error cargando el logo de VTC:", error);
        }
      }

      // Dibuja el título
      context.font = `bold 24px ${config.font}`;
      const title = customTitle || (altTextToggleInput.checked ? translation.titleComedic : translation.titleNormal);
      context.fillText(title, canvas.width / 2 - context.measureText(title).width / 2, 50);

      // Dibuja la marca de agua
      context.font = `italic 20px ${config.font}`;
      context.globalAlpha = 0.1;
      const watermark = "CONVOYRAMA";
      context.fillText(watermark, canvas.width / 2 - context.measureText(watermark).width / 2, canvas.height - 20);
      context.globalAlpha = 1.0;

      // Actualiza el enlace de descarga
      document.getElementById("descargar").href = canvas.toDataURL("image/png");
    }

    // Debounce para la generación de la imagen
    const debouncedGenerateImage = debounce(generateImage, 300);

    // Event listeners
    nameInput.addEventListener("input", updateForm);
    photoInput.addEventListener("change", () => {
      const file = photoInput.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = (e) => {
          userImage = new Image();
          userImage.src = e.target.result;
          userImage.onload = debouncedGenerateImage;
        };
        reader.readAsDataURL(file);
      } else {
        userImage = null;
        debouncedGenerateImage();
      }
    });
    countryInput.addEventListener("change", () => {
      saveDefaultCountry();
      debouncedGenerateImage();
    });
    nicknameInput.addEventListener("change", debouncedGenerateImage);
    truckersmpLinkInput.addEventListener("input", () => {
      validateTruckersmpLink(truckersmpLinkInput.value.trim());
      debouncedGenerateImage();
    });
    companyLinkInput.addEventListener("input", () => {
      updateForm();
    });
    altTextToggleInput.addEventListener("change", debouncedGenerateImage);
    promodsToggleInput.addEventListener("change", debouncedGenerateImage);
    dbusworldToggleInput.addEventListener("change", debouncedGenerateImage);
    vtcLogoToggleInput.addEventListener("change", debouncedGenerateImage);
    languageToggle.addEventListener("change", () => updateLanguage(languageToggle.value));
    colorSlider.addEventListener("input", () => {
      colorValue.textContent = `${colorSlider.value}°`;
      debouncedGenerateImage();
    });
    customTitleInput.addEventListener("input", debouncedGenerateImage);

    // Inicialización
    loadDefaultCountry();
    updateLanguage(currentLanguage);
    debouncedGenerateImage();
  </script>
</body>
</html>
