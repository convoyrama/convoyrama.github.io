#!/bin/bash
f="./vtcData.json";[ ! `command -v jq` ]&&{ echo "E:jq";exit 1;};[ ! -f "$f" ]&&{ echo '{"a":[],"b":{}}'>"$f";echo "F $f";};x3(){ local a=$1 b=$2;[ "$b" == "p" ]&&[[ ! "$a" =~ ^https://truckersmp\.com/user/[0-9]+$ ]]&&{ echo "E:p";return 1;};[ "$b" == "c" ]&&[[ ! "$a" =~ ^https://truckersmp\.com/vtc/[0-9]+(-[a-zA-Z0-9-]+)?$ ]]&&{ echo "E:c";return 1;};return 0;};x4(){ local a=$1;echo "$a"|sed 's/\/\+$//'|sed 's/\?.*$//'|sed 's/-[a-z0-9-]\+$//';};echo "D:";read -p "N: " a1;[ -z "$a1" ]&&{ echo "E:n";exit 1;};read -p "P: " a2;x3 "$a2" "p"||exit 1;b2=$(x4 "$a2");read -p "C: " a3;x3 "$a3" "c"||exit 1;b3=$(x4 "$a3");c1=$(jq -r ".a[]|select(.profileLink==\"$b2\" and .companyLink==\"$b3\")|.name" "$f");[ ! -z "$c1" ]&&{ echo "E:d $b2 $b3";exit 1;};d1=$(jq -n --arg n "$a1" --arg p "$b2" --arg c "$b3" '{name:$n,profileLink:$p,companyLink:$c}');t1=$(mktemp);jq ".a+=[${d1}]" "$f">"$t1";[ $? -ne 0 ]&&{ echo "E:j";rm "$t1";exit 1;};mv "$t1" "$f";echo "S:";cat "$f";echo -e "\nF:";jq '.' "$f"
