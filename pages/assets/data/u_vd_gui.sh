#!/bin/bash
f="./vtcData.json";[ ! `command -v jq` ]&&{ zenity --error --text="E:jq" --width=400;exit 1;};[ ! `command -v zenity` ]&&{ echo "E:zenity";exit 1;};[ ! -f "$f" ]&&{ echo '{"a":[],"b":{}}'>"$f";zenity --info --text="F $f" --width=400;};x3(){ local a=$1 b=$2;[ "$b" == "p" ]&&[[ ! "$a" =~ ^https://truckersmp\.com/user/[0-9]+$ ]]&&{ zenity --error --text="E:p" --width=400;return 1;};[ "$b" == "c" ]&&[[ ! "$a" =~ ^https://truckersmp\.com/vtc/[0-9]+(-[a-zA-Z0-9-]+)?$ ]]&&{ zenity --error --text="E:c" --width=400;return 1;};return 0;};x4(){ local a=$1;echo "$a"|sed 's/\/\+$//'|sed 's/\?.*$//'|sed 's/-[a-z0-9-]\+$//';};a1=$(zenity --entry --title="A" --text="N:" --width=500);[ $? -ne 0 ]&&{ zenity --info --text="C" --width=400;exit 0;};[ -z "$a1" ]&&{ zenity --error --text="E:n" --width=400;exit 1;};a2=$(zenity --entry --title="A" --text="P:" --width=500 --entry-text="https://truckersmp.com/user/");[ $? -ne 0 ]&&{ zenity --info --text="C" --width=400;exit 0;};x3 "$a2" "p"||exit 1;b2=$(x4 "$a2");a3=$(zenity --entry --title="A" --text="C:" --width=500 --entry-text="https://truckersmp.com/vtc/");[ $? -ne 0 ]&&{ zenity --info --text="C" --width=400;exit 0;};x3 "$a3" "c"||exit 1;b3=$(x4 "$a3");c1=$(jq -r ".a[]|select(.profileLink==\"$b2\" and .companyLink==\"$b3\")|.name" "$f");[ ! -z "$c1" ]&&{ zenity --error --text="E:d $b2 $b3" --width=400;exit 1;};d1=$(jq -n --arg n "$a1" --arg p "$b2" --arg c "$b3" '{name:$n,profileLink:$p,companyLink:$c}');t1=$(mktemp);jq ".a+=[${d1}]" "$f">"$t1";[ $? -ne 0 ]&&{ zenity --error --text="E:j" --width=400;rm "$t1";exit 1;};mv "$t1" "$f";zenity --text-info --title="S" --width=600 --height=400 --filename="$f"
