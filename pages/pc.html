<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Convoyrama | Creador de Imágenes de Perfil</title>
  <meta name="description" content="Convoyrama - Creador de Imágenes de Perfil">
  <link rel="stylesheet" href="./assets/style.css">
  <link rel="icon" href="./assets/images/favicon.png">
  <link rel="apple-touch-icon" href="./assets/images/favicon.png">
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@700&family=Merriweather:wght@700&family=Roboto:wght@700&family=Lora:wght@700&display=swap" rel="stylesheet">
  <!-- Twemoji Library -->
  <script src="https://twemoji.maxcdn.com/v/latest/twemoji.min.js" crossorigin="anonymous"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      position: relative;
      min-height: 100vh;
    }

    header {
      padding: 15px;
      text-align: center;
      position: relative;
      z-index: 10;
      background: var(--accent-bg);
      border-bottom: 1px solid var(--border);
    }

    header p {
      font-size: 1.2em;
      text-shadow: none;
      font-family: Arial, sans-serif;
      font-weight: normal;
      margin: 10px 0;
      color: #fff;
    }

    nav {
      padding: 10px;
      text-align: center;
    }

    nav a,
    nav a:visited {
      text-decoration: none;
      margin: 0 15px;
      font-size: 1em;
      text-shadow: none;
      color: #fff;
    }

    nav a:hover {
      text-decoration: underline;
    }

    .contenedor {
      display: flex;
      gap: 20px;
      padding: 20px;
      align-items: flex-start;
      position: relative;
      z-index: 10;
    }

    .panel {
      flex: 1;
      max-width: 300px;
      font-size: 14px;
    }

    .panel h3 {
      margin: 10px 0 5px;
      font-size: 14px;
      text-shadow: none;
    }

    .input-group {
      margin: 6px 0;
    }

    .input-group label {
      text-shadow: none;
    }

    canvas {
      border: 1px solid #000;
      display: block;
      max-width: 100%;
      height: auto;
    }

    #preview {
      flex: 1;
      text-align: center;
    }

    button {
      padding: 6px 12px;
      font-size: 14px;
      margin-top: 10px;
      background: rgb(90,165,25);
      color: #fff;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      text-shadow: none;
    }

    button:hover {
      opacity: 0.8;
    }

    .controls {
      margin-bottom: 20px;
      padding: 10px;
      background: none;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .controls label {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
      text-shadow: none;
      width: 100%;
    }

    .controls input[type="checkbox"] {
      width: 16px;
      height: 16px;
      cursor: pointer;
      flex-shrink: 0;
    }

    footer {
      color: white;
      text-align: center;
      padding: 10px;
      position: relative;
      z-index: 10;
      margin-top: auto;
    }

    footer small {
      text-shadow: none;
    }

    .ls-only {
      display: none;
    }
  </style>
</head>

<body>
  <header>
    <nav>
      <a href="../index.html">Home</a>
      <a href="pc.html">Creador de Perfil</a>
      <a href="id.html">Licencia</a>
    </nav>
    <p id="headerTitle">Generador de Imágenes de Perfil</p>
  </header>

  <div class="contenedor">
    <!-- Panel de controles -->
    <div class="panel">
      <div class="controls">
        <label class="ls-only">
          <input type="checkbox" id="baseLayerToggle" checked>
          Usar fondo base LS
        </label>
        <label class="ls-only">
          <input type="checkbox" id="topLayerToggle">
          Usar capa superior LS
        </label>
      </div>

      <div class="input-group">
        <label for="empresa">Empresa (Fuente: <span id="fontName">Open Sans</span>):</label><br>
        <select id="empresa" style="width:100%">
          <option value="LS" selected>LS</option>
          <option value="CN">CN</option>
          <option value="CDS">CDS</option>
          <option value="TCS">TCS</option>
        </select>
      </div>

      <div class="input-group">
        <label for="nombre">Nombre:</label><br>
        <input type="text" id="nombre" placeholder="Nombre">
      </div>

      <div class="input-group">
        <label for="size">Tamaño nombre: <output id="sizeValue">60</output>px</label><br>
        <input type="range" id="size" min="30" max="150" aria-valuenow="60">
      </div>

      <div class="input-group">
        <label for="pais">País:</label><br>
        <select id="pais" style="width:100%">
          <option value="🇦🇷">Argentina</option>
          <option value="🇧🇴">Bolivia</option>
          <option value="🇧🇷">Brasil</option>
          <option value="🇨🇦">Canadá</option>
          <option value="🇨🇱">Chile</option>
          <option value="🇨🇴">Colombia</option>
          <option value="🇨🇷">Costa Rica</option>
          <option value="🇨🇺">Cuba</option>
          <option value="🇩🇴">República Dominicana</option>
          <option value="🇪🇨">Ecuador</option>
          <option value="🇸🇻">El Salvador</option>
          <option value="🇪🇸">España</option>
          <option value="🇬🇹">Guatemala</option>
          <option value="🇭🇳">Honduras</option>
          <option value="🇲🇽">México</option>
          <option value="🇳🇮">Nicaragua</option>
          <option value="🇵🇦">Panamá</option>
          <option value="🇵🇾">Paraguay</option>
          <option value="🇵🇪">Perú</option>
          <option value="🇵🇹">Portugal</option>
          <option value="🇺🇸">Estados Unidos</option>
          <option value="🇺🇾">Uruguay</option>
          <option value="🇻🇪">Venezuela</option>
        </select>
      </div>

      <div class="input-group">
        <label for="flagSize">Tamaño bandera: <output id="flagSizeValue">120</output>px</label><br>
        <input type="range" id="flagSize" min="30" max="120" aria-valuenow="120">
      </div>

      <h3>Posiciones Verticales</h3>
      <div class="input-group">
        <label for="by">Bandera Y: <output id="byValue">235</output></label><br>
        <input type="range" id="by" min="30" max="480" aria-valuenow="235">
      </div>
      <div class="input-group">
        <label for="ny">Nombre Y: <output id="nyValue">350</output></label><br>
        <input type="range" id="ny" min="30" max="480" aria-valuenow="350">
      </div>

      <h3>Opciones de salida</h3>
      <div class="input-group">
        <label for="outSize">Tamaño final: <output id="outSizeValue">500</output>px</label><br>
        <input type="range" id="outSize" min="256" max="1024" step="64" aria-valuenow="500">
      </div>
      <div class="input-group">
        <label for="circular"><input type="checkbox" id="circular"> Circular</label>
      </div>
    </div>

    <!-- Preview -->
    <div id="preview">
      <canvas id="canvas" width="500" height="500"></canvas>
      <br>
      <a id="descargar" download="perfil.png">
        <button id="botonDescargar">Descargar</button>
      </a>
    </div>
  </div>

  <footer>
    <small>© LAG'S SPEED - CONVOYRAMA 2025</small>
  </footer>

  <script>
    function rasterizeTwemoji(emoji, size) {
      return new Promise((resolve) => {
        const img = new Image();
        img.onload = () => resolve(img);
        img.onerror = () => resolve(null);
        img.src = twemoji.parse(emoji, { folder: 'svg', ext: '.svg' }).match(/src="([^"]+)"/)[1];
        img.crossOrigin = "anonymous";
      });
    }

    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d");

    // Configuraciones por empresa
    const empresas = {
      "LS":  {
        backgroundLayer: "fondos/lsfondo.png",
        fondo: "fondos/ls.png",
        foregroundLayer: "fondos/lsplumas.png",
        color: "rgb(240,240,240)",
        size: 60,
        flagSize: 120,
        by: 235,
        ny: 350,
        outSize: 500,
        font: "'Open Sans', sans-serif"
      },
      "CN":  { fondo: "fondos/cn.png", color: "white", size: 100, flagSize: 50, by: 80, ny: 290, outSize: 500, font: "'Merriweather', serif" },
      "CDS": { fondo: "fondos/cds.png", color: "rgb(20,20,20)", sombra: "white", size: 90, flagSize: 90, by: 350, ny: 260, outSize: 500, font: "'Roboto', sans-serif" },
      "TCS": { fondo: "fondos/tcs.png", color: "white", size: 90, flagSize: 64, by: 200, ny: 435, outSize: 500, font: "'Lora', serif" }
    };

    // Inputs
    const empresaInput = document.getElementById("empresa");
    const nombreInput = document.getElementById("nombre");
    const paisInput = document.getElementById("pais");
    const sizeInput = document.getElementById("size");
    const flagSizeInput = document.getElementById("flagSize");
    const byInput = document.getElementById("by");
    const nyInput = document.getElementById("ny");
    const outSizeInput = document.getElementById("outSize");
    const circularInput = document.getElementById("circular");
    const baseLayerToggle = document.getElementById("baseLayerToggle");
    const topLayerToggle = document.getElementById("topLayerToggle");

    const sizeValue = document.getElementById("sizeValue");
    const flagSizeValue = document.getElementById("flagSizeValue");
    const byValue = document.getElementById("byValue");
    const nyValue = document.getElementById("nyValue");
    const outSizeValue = document.getElementById("outSizeValue");
    const fontName = document.getElementById("fontName");

    // Debounce function
    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }

    // Save and load default country
    function saveDefaultCountry() {
      localStorage.setItem("defaultCountry", paisInput.value);
    }
    function loadDefaultCountry() {
      const saved = localStorage.getItem("defaultCountry");
      if (saved) paisInput.value = saved;
    }

    // Aplica configuración por empresa
    function aplicarConfigEmpresa() {
      const emp = empresas[empresaInput.value];
      sizeInput.value = emp.size;
      flagSizeInput.value = emp.flagSize;
      byInput.value = emp.by;
      nyInput.value = emp.ny;
      outSizeInput.value = emp.outSize;
      sizeValue.textContent = emp.size;
      flagSizeValue.textContent = emp.flagSize;
      byValue.textContent = emp.by;
      nyValue.textContent = emp.ny;
      outSizeValue.textContent = emp.outSize;
      fontName.textContent = emp.font.split(",")[0].replace(/'/g, "");
      baseLayerToggle.checked = empresaInput.value === "LS";
      topLayerToggle.checked = false;
      document.querySelectorAll(".ls-only").forEach(el => {
        el.style.display = empresaInput.value === "LS" ? "block" : "none";
      });
      generarImagen();
    }

    // Generar/preview
    async function generarImagen() {
      const emp = empresas[empresaInput.value];
      const nombre = nombreInput.value || "Sin_nombre";
      const bandera = paisInput.value || "";
      const size = parseInt(sizeInput.value);
      const flagSize = parseInt(flagSizeInput.value);
      const by = parseInt(byInput.value);
      const ny = parseInt(nyInput.value);
      const outSize = parseInt(outSizeInput.value);
      const circular = circularInput.checked;
      const useBackgroundLayer = empresaInput.value === "LS" && baseLayerToggle.checked;
      const useForegroundLayer = empresaInput.value === "LS" && topLayerToggle.checked;

      // Actualizar labels and ARIA
      sizeValue.textContent = size;
      sizeInput.setAttribute("aria-valuenow", size);
      flagSizeValue.textContent = flagSize;
      flagSizeInput.setAttribute("aria-valuenow", flagSize);
      byValue.textContent = by;
      byInput.setAttribute("aria-valuenow", by);
      nyValue.textContent = ny;
      nyInput.setAttribute("aria-valuenow", ny);
      outSizeValue.textContent = outSize;
      outSizeInput.setAttribute("aria-valuenow", outSize);

      canvas.width = outSize;
      canvas.height = outSize;

      ctx.clearRect(0, 0, canvas.width, canvas.height);

      if (circular) {
        ctx.save();
        ctx.beginPath();
        ctx.arc(outSize / 2, outSize / 2, outSize / 2, 0, Math.PI * 2);
        ctx.closePath();
        ctx.clip();
      }

      // Dibujar capa de fondo LS si está habilitada
      if (useBackgroundLayer && emp.backgroundLayer) {
        const backgroundLayer = new Image();
        backgroundLayer.src = emp.backgroundLayer;
        await new Promise((resolve) => {
          backgroundLayer.onload = () => {
            ctx.drawImage(backgroundLayer, 0, 0, canvas.width, canvas.height);
            resolve();
          };
          backgroundLayer.onerror = () => {
            console.error("Failed to load background layer image (lsfondo.png)");
            resolve();
          };
        });
      }

      // Dibujar fondo principal
      const fondo = new Image();
      fondo.src = emp.fondo;
      await new Promise((resolve) => {
        fondo.onload = () => {
          ctx.drawImage(fondo, 0, 0, canvas.width, canvas.height);
          resolve();
        };
        fondo.onerror = () => {
          console.error("Failed to load main background image for", empresaInput.value);
          ctx.fillStyle = "transparent";
          resolve();
        };
      });

      // Dibujar contenido
      async function drawContent() {
        ctx.textAlign = "center";

        // Bandera usando Twemoji rasterizada
        if (bandera) {
          const flagImg = await rasterizeTwemoji(bandera, flagSize);
          if (flagImg) {
            ctx.drawImage(flagImg, canvas.width / 2 - flagSize / 2, by - flagSize, flagSize, flagSize);
          }
        }

        // Configurar sombra para CDS
        if (empresaInput.value === "CDS" && emp.sombra) {
          ctx.shadowColor = emp.sombra;
          ctx.shadowOffsetX = 2;
          ctx.shadowOffsetY = 2;
          ctx.shadowBlur = 0;
        } else {
          ctx.shadowColor = "transparent";
          ctx.shadowOffsetX = 0;
          ctx.shadowOffsetY = 0;
          ctx.shadowBlur = 0;
        }

        // Nombre
        ctx.font = `bold ${size}px ${emp.font}`;
        ctx.fillStyle = emp.color;
        ctx.fillText(nombre, canvas.width / 2, ny);

        // Dibujar capa de superposición LS si está habilitada
        if (useForegroundLayer && emp.foregroundLayer) {
          const foregroundLayer = new Image();
          foregroundLayer.src = emp.foregroundLayer;
          await new Promise((resolve) => {
            foregroundLayer.onload = () => {
              ctx.drawImage(foregroundLayer, 0, 0, canvas.width, canvas.height);
              resolve();
            };
            foregroundLayer.onerror = () => {
              console.error("Failed to load foreground layer image (lsplumas.png)");
              resolve();
            };
          });
        }
      }

      await drawContent();
      if (circular) ctx.restore();
      updateDownloadLink();

      function updateDownloadLink() {
        const enlace = document.getElementById("descargar");
        enlace.href = canvas.toDataURL("image/png");
        enlace.download = `perfil_${empresaInput.value}_${nombre}.png`;
      }
    }

    // Debounced image generation
    const debouncedGenerarImagen = debounce(generarImagen, 100);

    // Eventos para preview en vivo
    [nombreInput, paisInput, sizeInput, flagSizeInput, byInput, nyInput, outSizeInput, circularInput, baseLayerToggle, topLayerToggle]
      .forEach(el => el.addEventListener("input", debouncedGenerarImagen));
    empresaInput.addEventListener("change", aplicarConfigEmpresa);
    paisInput.addEventListener("change", saveDefaultCountry);

    // Inicializar
    function initialize() {
      loadDefaultCountry();
      aplicarConfigEmpresa();
    }

    initialize();
  </script>
</body>
</html>
