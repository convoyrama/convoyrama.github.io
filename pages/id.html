<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Convoyrama | Generador de Licencia</title>
  <meta name="description" content="Convoyrama">
  <link rel="stylesheet" href="../assets/style.css">
  <link rel="icon" href="../assets/images/favicon.png">
  <link rel="apple-touch-icon" href="../assets/images/favicon.png">
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@700&display=swap" rel="stylesheet">
  <!-- QRious Library -->
  <script src="https://cdn.jsdelivr.net/npm/qrious@4.0.2/dist/qrious.min.js"></script>
  <!-- Twemoji Library -->
  <script src="https://twemoji.maxcdn.com/v/latest/twemoji.min.js" crossorigin="anonymous"></script>
  <style>
    .contenedor {
      display: flex;
      gap: 20px;
      padding: 20px;
      align-items: flex-start;
      font-family: Arial, sans-serif;
    }
    .panel {
      flex: 1;
      max-width: 300px;
      font-size: 14px;
    }
    .panel h3 {
      margin: 10px 0 5px;
      font-size: 14px;
    }
    .input-group {
      margin: 6px 0;
    }
    canvas {
      border: 1px solid #000;
      display: block;
      max-width: 100%;
      height: auto;
    }
    #preview {
      flex: 1;
      text-align: center;
    }
    button {
      padding: 6px 12px;
      font-size: 14px;
      margin-top: 10px;
      background: rgb(90,165,25);
      color: #fff;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }
    button:hover {
      opacity: 0.8;
    }
    .hidden {
      display: none;
    }
  </style>
</head>

<body>
  <header>
    <nav>
      <a href="../index.html">Home</a>
      <a href="ls.html">LS</a>
      <a href="gen.html">TCS/CN/CDS</a>
      <a href="id.html">Licencia</a>
    </nav>
    <p>Generador de Licencia de Conductor</p>
  </header>

  <div class="contenedor">
    <!-- Panel de controles -->
    <div class="panel">
      <div class="input-group">
        <label>Fuente: <span id="fontName">Open Sans</span></label>
      </div>

      <div class="input-group">
        <label for="nombre">Nombre:</label><br>
        <input type="text" id="nombre" placeholder="Nombre" required>
      </div>

      <div class="input-group hidden" id="nicknameGroup">
        <label for="nickname">TAG 칄pico:</label><br>
        <select id="nickname" style="width:100%">
          <option value="">Seleccione un TAG</option>
          <option value="ReyDelLag">ReyDelLag</option>
          <option value="CamioneroSinPesos">CamioneroSinPesos</option>
          <option value="AsDelVolanteChocado">AsDelVolanteChocado</option>
          <option value="FrenadorEnCurva">FrenadorEnCurva</option>
          <option value="Se침orDelLagazo">Se침orDelLagazo</option>
          <option value="RutaSinPlata">RutaSinPlata</option>
          <option value="ChoferDeLaCrisis">ChoferDeLaCrisis</option>
          <option value="BocinaLoca">BocinaLoca</option>
          <option value="Cami칩nFantasma">Cami칩nFantasma</option>
          <option value="Lagman Latino">Lagman Latino</option>
          <option value="TransportistaT칤mido">TransportistaT칤mido</option>
          <option value="ReyDelConvoyCa칩tico">ReyDelConvoyCa칩tico</option>
          <option value="CargadorDeDeudas">CargadorDeDeudas</option>
          <option value="MaestroDelPing500">MaestroDelPing500</option>
          <option value="FugitivoDeLaRuta">FugitivoDeLaRuta</option>
          <option value="CamioneroDelApag칩n">CamioneroDelApag칩n</option>
          <option value="L칤derDelDescontrol">L칤derDelDescontrol</option>
          <option value="CargaConDrama">CargaConDrama</option>
          <option value="VolanteVengador">VolanteVengador</option>
          <option value="RutaSinWiFi">RutaSinWiFi</option>
        </select>
      </div>

      <div class="input-group hidden" id="titleToggleGroup">
        <label for="titleToggle">Usar t칤tulo c칩mico:</label><br>
        <input type="checkbox" id="titleToggle">
      </div>

      <div class="input-group">
        <label for="foto">Foto (Opcional):</label><br>
        <input type="file" id="foto" accept="image/*">
      </div>

      <div class="input-group">
        <label for="pais">Pa칤s:</label><br>
        <select id="pais" style="width:100%" required>
          <option value="">Seleccione un pa칤s</option>
          <option value="AR|游뷣릖읖Argentina">游뷣릖 Argentina</option>
          <option value="BO|游游앞Bolivia">游游 Bolivia</option>
          <option value="BR|游游읖Brasil">游游 Brasil</option>
          <option value="CA|游뻟릖뵾Canad치">游뻟릖 Canad치</option>
          <option value="CL|游뻟릖쎺Chile">游뻟릖 Chile</option>
          <option value="CO|游뻟릖앞Colombia">游뻟릖 Colombia</option>
          <option value="CR|游뻟릖읖Costa Rica">游뻟릖 Costa Rica</option>
          <option value="CU|游뻟릖죺Cuba">游뻟릖 Cuba</option>
          <option value="DO|游뾇릖앞Rep칰blica Dominicana">游뾇릖 Rep칰blica Dominicana</option>
          <option value="EC|游쀯릖빺Ecuador">游쀯릖 Ecuador</option>
          <option value="SV|游젏릖즢El Salvador">游젏릖 El Salvador</option>
          <option value="ES|游쀯릖잪Espa침a">游쀯릖 Espa침a</option>
          <option value="GT|游섫릖졒Guatemala">游섫릖 Guatemala</option>
          <option value="HN|游쇓릖씊Honduras">游쇓릖 Honduras</option>
          <option value="MX|游쓇릖쪞M칠xico">游쓇릖 M칠xico</option>
          <option value="NI|游游숖Nicaragua">游游 Nicaragua</option>
          <option value="PA|游왫릖뵾Panam치">游왫릖 Panam치</option>
          <option value="PY|游왫릖쭆Paraguay">游왫릖 Paraguay</option>
          <option value="PE|游왫릖뿊Per칰">游왫릖 Per칰</option>
          <option value="PT|游왫릖졒Portugal">游왫릖 Portugal</option>
          <option value="US|游쥟릖잪Estados Unidos">游쥟릖 Estados Unidos</option>
          <option value="UY|游쥟릖쭆Uruguay" selected>游쥟릖 Uruguay</option>
          <option value="VE|游游뿊Venezuela">游游 Venezuela</option>
        </select>
      </div>

      <div class="input-group">
        <label for="empresa">Empresa:</label><br>
        <select id="empresa" style="width:100%" onchange="updateForm()">
          <option value="LS" selected>LS</option>
          <option value="CN">CN</option>
          <option value="TCS">TCS</option>
          <option value="Otro">Otro</option>
        </select>
      </div>

      <div class="input-group hidden" id="empresaLinkGroup">
        <label for="empresaLink">Enlace Perfil Empresa en TMP:</label><br>
        <input type="text" id="empresaLink" placeholder="TruckersMP Company Profile Link" required>
      </div>

      <div class="input-group">
        <label for="truckersmpLink">Enlace Perfil en TMP:</label><br>
        <input type="text" id="truckersmpLink" placeholder="TruckersMP Profile Link" required>
      </div>
    </div>

    <!-- Preview -->
    <div id="preview">
      <canvas id="canvas" width="800" height="500"></canvas>
      <br>
      <a id="descargar" download="driver_license.png">
        <button id="botonDescargar">Descargar Licencia</button>
      </a>
    </div>
  </div>

  <footer>
    <small>춸 LAG'S SPEED - CONVOYRAMA 2025</small>
  </footer>

  <script>
    function rasterizeTwemoji(emoji, size) {
      return new Promise((resolve) => {
        const img = new Image();
        img.onload = () => resolve(img);
        img.onerror = () => resolve(null);
        img.src = twemoji.parse(emoji, { folder: 'svg', ext: '.svg' }).match(/src="([^"]+)"/)[1];
        img.crossOrigin = "anonymous";
      });
    }

    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d");

    const config = {
      template: "assets/images/license_template_ls.png",
      color: "white",
      flagSize: 80,
      photoX: 45,
      photoY: 80,
      labelX: 100,
      colonX: 130,
      textX: 295,
      textY: 334,
      qrX: 573,
      qrY: 101,
      flagX: 625,
      flagY: 206,
      font: "'Open Sans', Arial, sans-serif", // Added Arial as fallback
      defaultPhotoSize: 192,
      qrSize: 100,
      qrSpacing: 10
    };

    const nombreInput = document.getElementById("nombre");
    const fotoInput = document.getElementById("foto");
    const paisInput = document.getElementById("pais");
    const nicknameInput = document.getElementById("nickname");
    const empresaInput = document.getElementById("empresa");
    const empresaLinkInput = document.getElementById("empresaLink");
    const truckersmpLinkInput = document.getElementById("truckersmpLink");
    const empresaLinkGroup = document.getElementById("empresaLinkGroup");
    const nicknameGroup = document.getElementById("nicknameGroup");
    const titleToggleGroup = document.getElementById("titleToggleGroup");
    const titleToggleInput = document.getElementById("titleToggle");

    let userImage = null;
    let isNicknameUnlocked = localStorage.getItem("nicknameUnlocked") === "true";
    let cachedDate = null;
    let lastDateFetch = 0;
    const DATE_CACHE_DURATION = 60 * 1000; // Cache date for 60 seconds

    function generarLicenseNumber(nombre, pais, truckersmpLink) {
      const countryCode = pais.split("|")[0].substring(0, 2) || "XX";
      let userId = "";
      if (truckersmpLink) {
        const match = truckersmpLink.match(/truckersmp\.com\/user\/(\d+)/);
        userId = match ? match[1] : "";
      }
      if (userId) {
        return `${countryCode}${userId}`;
      }
      return "";
    }

    async function getCurrentDate() {
      const now = Date.now();
      if (cachedDate && now - lastDateFetch < DATE_CACHE_DURATION) {
        console.log("Using cached date:", cachedDate);
        return cachedDate;
      }
      try {
        const response = await fetch('http://worldtimeapi.org/api/timezone/Etc/UTC');
        const data = await response.json();
        const date = new Date(data.datetime);
        const day = date.getDate().toString().padStart(2, "0");
        const month = (date.getMonth() + 1).toString().padStart(2, "0");
        const year = date.getFullYear();
        cachedDate = `${day}/${month}/${year}`;
        lastDateFetch = now;
        console.log("Fetched new date:", cachedDate);
        return cachedDate;
      } catch (error) {
        console.error("Failed to fetch date from API, falling back to system date:", error);
        const date = new Date();
        const day = date.getDate().toString().padStart(2, "0");
        const month = (date.getMonth() + 1).toString().padStart(2, "0");
        const year = date.getFullYear();
        cachedDate = `${day}/${month}/${year}`;
        lastDateFetch = now;
        return cachedDate;
      }
    }

    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }

    function saveDefaultCountry() {
      localStorage.setItem("defaultCountry", paisInput.value);
    }
    function loadDefaultCountry() {
      const saved = localStorage.getItem("defaultCountry");
      if (saved) paisInput.value = saved;
    }

    function updateForm() {
      console.log("updateForm triggered"); // Debug log
      const empresa = empresaInput.value;
      empresaLinkGroup.classList.toggle("hidden", empresa !== "Otro");
      const nombre = nombreInput.value.toLowerCase().trim();
      if (["convoyrama", "nocturnoverso"].includes(nombre)) {
        isNicknameUnlocked = true;
        localStorage.setItem("nicknameUnlocked", "true");
      }
      nicknameGroup.classList.toggle("hidden", !isNicknameUnlocked);
      titleToggleGroup.classList.toggle("hidden", !isNicknameUnlocked);
      debouncedGenerarImagen(); // Use debounced version
    }

    function aplicarConfig() {
      updateForm();
    }

    // Store previous form state to avoid redundant redraws
    let lastFormState = {};

    function getFormState() {
      return {
        nombre: nombreInput.value,
        pais: paisInput.value,
        nickname: nicknameInput.value,
        empresa: empresaInput.value,
        truckersmpLink: truckersmpLinkInput.value,
        empresaLink: empresaLinkInput.value,
        titleToggle: titleToggleInput.checked,
        userImage: userImage ? userImage.src : null
      };
    }

    async function generarImagen() {
      console.log("generarImagen triggered"); // Debug log
      const formState = getFormState();
      if (JSON.stringify(formState) === JSON.stringify(lastFormState)) {
        console.log("No changes in form state, skipping redraw");
        return;
      }
      lastFormState = formState;

      const nombre = nombreInput.value || "Sin nombre";
      const paisData = paisInput.value.split("|");
      const countryCode = paisData[0] || "XX";
      const flag = paisData[1] || "";
      const countryName = paisData[2] || "Sin pa칤s";
      const nickname = nicknameInput.value || "";
      const empresa = empresaInput.value;
      const truckersmpLink = truckersmpLinkInput.value.trim();
      const empresaLink = empresa === "Otro" ? empresaLinkInput.value.trim() : null;

      // Set canvas dimensions only if needed
      if (canvas.width !== 800 || canvas.height !== 500) {
        canvas.width = 800;
        canvas.height = 500;
      }

      // Clear canvas and reset context state
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.font = null;
      ctx.fillStyle = null;
      ctx.textAlign = "start";
      ctx.textBaseline = "alphabetic";
      ctx.shadowColor = "transparent";
      ctx.globalCompositeOperation = "source-over";

      // Load template
      config.template = `assets/images/license_template_${empresa.toLowerCase()}.png`;
      const template = new Image();
      template.src = config.template;

      // Wait for all images to load
      const [templateImg, silhouetteImg, flagImg, idImg, leftQrImg] = await Promise.all([
        new Promise((resolve) => {
          template.onload = () => resolve(template);
          template.onerror = () => {
            console.error("Failed to load license template image");
            resolve(null);
          };
        }),
        userImage ? Promise.resolve(null) : rasterizeTwemoji("游녻", config.defaultPhotoSize),
        flag ? rasterizeTwemoji(flag, config.flagSize) : Promise.resolve(null),
        truckersmpLink ? new Promise((resolve) => {
          const img = new Image();
          img.src = "assets/images/id.svg";
          img.onload = () => resolve(img);
          img.onerror = () => {
            console.error("Failed to load id.svg");
            resolve(null);
          };
        }) : Promise.resolve(null),
        truckersmpLink && (empresa === "LS" || empresa === "CN" || empresa === "TCS") ? new Promise((resolve) => {
          const img = new Image();
          img.src = `assets/images/qr${empresa.toLowerCase()}.svg`;
          img.onload = () => resolve(img);
          img.onerror = () => {
            console.error(`Failed to load qr${empresa.toLowerCase()}.svg`);
            resolve(null);
          };
        }) : Promise.resolve(null)
      ]);

      // Draw template or fallback
      if (templateImg) {
        ctx.drawImage(templateImg, 0, 0, canvas.width, canvas.height);
      } else {
        ctx.fillStyle = "#fff";
        ctx.fillRect(0, 0, canvas.width, canvas.height);
      }

      // Draw content
      if (userImage) {
        const photoSize = config.defaultPhotoSize;
        ctx.drawImage(userImage, config.photoX, config.photoY, photoSize, photoSize);
      } else if (silhouetteImg) {
        ctx.drawImage(silhouetteImg, config.photoX, config.photoY, config.defaultPhotoSize, config.defaultPhotoSize);
      }

      if (flagImg) {
        ctx.drawImage(flagImg, config.flagX - config.flagSize / 2, config.flagY, config.flagSize, config.flagSize);
      }

      const currentDate = await getCurrentDate();
      ctx.font = `bold 24px ${config.font}`;
      ctx.fillStyle = config.color;
      ctx.textAlign = "left";

      const lineHeight = 24 * 1.2;
      ctx.fillText("Nombre :", config.labelX, config.textY);
      ctx.fillText("N칰m. Licencia :", config.labelX, config.textY + lineHeight);
      ctx.fillText("Fecha :", config.labelX, config.textY + lineHeight * 2);
      ctx.fillText("Pa칤s :", config.labelX, config.textY + lineHeight * 3);
      if (isNicknameUnlocked && nickname) {
        ctx.fillText("TAG :", config.labelX, config.textY + lineHeight * 4);
      }

      ctx.fillText(nombre, config.textX, config.textY);
      if (nombre && nombre.trim() !== "" && paisInput.value && truckersmpLink) {
        const licenseNumber = generarLicenseNumber(nombre, paisInput.value, truckersmpLink);
        if (licenseNumber) {
          ctx.fillText(licenseNumber, config.textX, config.textY + lineHeight);
        }
      }
      ctx.fillText(currentDate, config.textX, config.textY + lineHeight * 2);
      ctx.fillText(countryName, config.textX, config.textY + lineHeight * 3);
      if (isNicknameUnlocked && nickname) {
        ctx.fillText(nickname, config.textX, config.textY + lineHeight * 4);
      }

      const titleText = isNicknameUnlocked && titleToggleInput.checked ? "PERMISO PARA CHOCAR EN CONVOY" : "PERMISO DE CONDUCCI칍N INTERNACIONAL";
      const titleY = canvas.height - 5;
      ctx.font = `bold 22px ${config.font}`;
      ctx.fillStyle = "rgb(240, 240, 240)";
      ctx.textAlign = "center";
      ctx.textBaseline = "bottom";
      ctx.shadowColor = "rgb(0, 0, 0)";
      ctx.shadowOffsetX = 1;
      ctx.shadowOffsetY = 1;
      ctx.shadowBlur = 2;
      ctx.fillText(titleText, canvas.width / 2, titleY);
      ctx.shadowColor = "transparent";

      if (truckersmpLink) {
        const qrPersonal = new QRious({
          value: truckersmpLink,
          size: config.qrSize,
          level: 'H'
        });
        const qrPersonalCanvas = document.createElement("canvas");
        qrPersonalCanvas.width = config.qrSize;
        qrPersonalCanvas.height = config.qrSize;
        const qrPersonalCtx = qrPersonalCanvas.getContext("2d");
        qrPersonalCtx.drawImage(qrPersonal.canvas, 0, 0);
        ctx.drawImage(qrPersonalCanvas, config.qrX, config.qrY, config.qrSize, config.qrSize);

        if (idImg) {
          ctx.drawImage(idImg, config.qrX + config.qrSize + config.qrSpacing, config.qrY, config.qrSize, config.qrSize);
        }

        if (empresa === "LS" || empresa === "CN" || empresa === "TCS") {
          if (leftQrImg) {
            ctx.drawImage(leftQrImg, config.qrX - config.qrSize - config.qrSpacing, config.qrY, config.qrSize, config.qrSize);
          }
        } else if (empresa === "Otro" && empresaLink) {
          const qrEmpresa = new QRious({
            value: empresaLink,
            size: config.qrSize,
            level: 'H'
          });
          const qrEmpresaCanvas = document.createElement("canvas");
          qrEmpresaCanvas.width = config.qrSize;
          qrEmpresaCanvas.height = config.qrSize;
          const qrEmpresaCtx = qrEmpresaCanvas.getContext("2d");
          qrEmpresaCtx.drawImage(qrEmpresa.canvas, 0, 0);
          ctx.drawImage(qrEmpresaCanvas, config.qrX - config.qrSize - config.qrSpacing, config.qrY, config.qrSize, config.qrSize);
        }
      }

      updateDownloadLink();
      console.log("Canvas redraw complete for empresa:", empresa);

      function updateDownloadLink() {
        const enlace = document.getElementById("descargar");
        enlace.href = canvas.toDataURL("image/png");
        enlace.download = `driver_license_${nombre}_${empresa}.png`;
      }
    }

    fotoInput.addEventListener("change", (e) => {
      console.log("fotoInput changed"); // Debug log
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = (event) => {
          userImage = new Image();
          userImage.src = event.target.result;
          userImage.onload = debouncedGenerarImagen;
        };
        reader.readAsDataURL(file);
      } else {
        userImage = null;
        debouncedGenerarImagen();
      }
    });

    const debouncedGenerarImagen = debounce(generarImagen, 100); // Increased to 100ms

    [nombreInput, paisInput, nicknameInput, truckersmpLinkInput, empresaLinkInput, titleToggleInput]
      .forEach(el => el.addEventListener("input", (e) => {
        console.log(`Input event on ${el.id}`); // Debug log
        debouncedGenerarImagen();
      }));
    paisInput.addEventListener("change", saveDefaultCountry);
    empresaInput.addEventListener("change", updateForm);
    nombreInput.addEventListener("input", updateForm);

    async function initialize() {
      console.log("Initializing");
      loadDefaultCountry();
      nicknameGroup.classList.toggle("hidden", !isNicknameUnlocked);
      titleToggleGroup.classList.toggle("hidden", !isNicknameUnlocked);
      await debouncedGenerarImagen();
    }

    initialize();
  </script>
</body>
</html>
